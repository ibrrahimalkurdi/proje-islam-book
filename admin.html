<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin V5 - Ultimate Control</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-dark: #1e293b;
            --primary: #3b82f6;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --header-h: 70px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Vazirmatn', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow-x: hidden; }

        /* HEADER */
        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: var(--header-h); background: var(--panel-dark); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .menu-btn { font-size: 1.5rem; cursor: pointer; padding: 10px; }
        .admin-title { font-weight: 900; font-size: 1.2rem; color: var(--primary); letter-spacing: 1px; }

        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: var(--panel-dark); z-index: 2000; box-shadow: -5px 0 30px rgba(0,0,0,0.5); transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .sidebar.active { right: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .menu { flex: 1; overflow-y: auto; padding: 20px 10px; }
        .menu-item { padding: 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 15px; font-weight: 600; transition: 0.2s; }
        .menu-item.active { background: var(--primary); color: white; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1500; display: none; backdrop-filter: blur(3px); }
        .overlay.active { display: block; }

        /* CONTENT */
        .content { padding: calc(var(--header-h) + 20px) 20px 100px 20px; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }

        /* COMPONENTS */
        .card { background: var(--panel-dark); padding: 20px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.85rem; }
        .input { width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; color: white; }
        .input:focus { border-color: var(--primary); }
        
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--accent); color: black; }
        .btn-info { background: #6366f1; }
        .btn-sm { width: auto; padding: 5px 15px; font-size: 0.9rem; }

        /* TABLES */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid var(--border); }
        th { color: var(--text-muted); }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: var(--panel-dark); width: 100%; max-width: 650px; padding: 25px; border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        
        .city-tag, .point-rule-tag { background: var(--bg-dark); border: 1px solid var(--border); padding: 5px 10px; border-radius: 15px; display: inline-flex; align-items: center; gap: 10px; margin: 3px; font-size: 0.9rem; }
        
        /* ORDER DETAILS SPECIFIC CSS */
        .order-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; }
        .info-row { display: flex; align-items: center; gap: 10px; color: var(--text-muted); font-size: 0.9rem; }
        .info-row b { color: var(--text-main); }
        .verify-code-display { text-align: center; background: rgba(16, 185, 129, 0.1); border: 2px dashed var(--success); padding: 15px; border-radius: 10px; margin: 20px 0; }
        .verify-code-val { font-size: 2.5rem; font-weight: 900; letter-spacing: 8px; color: var(--success); font-family: monospace; }
        .receipt-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="menu-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
        <div class="admin-title">ADMIN V5 <i class="fas fa-shield-alt"></i></div>
        <div></div>
    </div>
    <div class="overlay" onclick="toggleMenu()"></div>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span>Ù„ÛŒØ³ØªØ§ Ø³Û•Ø±Û•Ú©ÛŒ</span>
            <i class="fas fa-times" onclick="toggleMenu()" style="cursor:pointer; color:var(--danger);"></i>
        </div>
        <div class="menu">
            <div class="menu-item active" onclick="nav('dashboard', this)"><i class="fas fa-home"></i> Ø³Û•Ø±Û•Ú©ÛŒ</div>
            <div class="menu-item" onclick="nav('users', this)"><i class="fas fa-users-cog"></i> Ø¨Ú©Ø§Ø±Ø¦ÛŒÙ†Û•Ø± (Full Control)</div>
            <div class="menu-item" onclick="nav('books', this)"><i class="fas fa-book"></i> Ù¾Û•Ø±ØªÙˆÙˆÚ© (Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ)</div>
            <div class="menu-item" onclick="nav('libraries', this)"><i class="fas fa-building"></i> Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û•</div>
            <div class="menu-item" onclick="nav('marketing', this)"><i class="fas fa-tags"></i> Ù…Ø§Ø±Ú©ÛØªÛŒÙ†Ú¯ & Ø®Ø§Úµ</div>
            <div class="menu-item" onclick="nav('settings', this)"><i class="fas fa-map-marker-alt"></i> Ø¨Ø§Ú˜ÛÚ• & Ú•ÛÚ©Ø®Ø³ØªÙ†</div>
        </div>
    </div>

    <!-- CONTENT -->
    <div class="content">

        <!-- 1. DASHBOARD -->
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom:20px;">Ø¯Ø§Ø´Ø¨Û†Ø±Ø¯</h2>
            <div class="grid-4">
                <div class="card" style="text-align:center;">
                    <i class="fas fa-wallet fa-2x" style="color:var(--success); margin-bottom:10px;"></i>
                    <h2 id="d-revenue">0</h2>
                    <small>Ø¯Ø§Ù‡Ø§Øª (IQD)</small>
                </div>
                <div class="card" style="text-align:center;">
                    <i class="fas fa-shopping-cart fa-2x" style="color:var(--accent); margin-bottom:10px;"></i>
                    <h2 id="d-orders">0</h2>
                    <small>Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ</small>
                </div>
                <div class="card" style="text-align:center;">
                    <i class="fas fa-book fa-2x" style="color:var(--primary); margin-bottom:10px;"></i>
                    <h2 id="d-books">0</h2>
                    <small>Ù¾Û•Ø±ØªÙˆÙˆÚ©</small>
                </div>
                <div class="card" style="text-align:center;">
                    <i class="fas fa-users fa-2x" style="color:var(--danger); margin-bottom:10px;"></i>
                    <h2 id="d-users">0</h2>
                    <small>Ø¨Ú©Ø§Ø±Ø¦ÛŒÙ†Û•Ø±</small>
                </div>
            </div>
            
            <div class="card">
                <h3>Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛÙ† Ø¯Ø§ÙˆÛŒÛ</h3>
                <div class="table-responsive">
                    <table id="dash-orders-table"></table>
                </div>
            </div>
        </div>

        <!-- 2. USERS (FULL DETAILS) -->
        <div id="users" class="section">
            <h2 style="margin-bottom:15px;">Ú©Û†Ù†ØªØ±Û†ÚµØ§ Ø¨Ú©Ø§Ø±Ø¦ÛŒÙ†Û•Ø±Ø§Ù† (Advanced)</h2>
            <input type="text" class="input" placeholder="Ù„ÛÚ¯Û•Ø±ÛŒØ§Ù† (Ù…Û†Ø¨Ø§ÛŒÙ„ ÛŒØ§Ù† Ù†Ø§Ú¤)..." oninput="admin.searchUser(this.value)" style="margin-bottom:20px;">
            <div class="table-responsive card">
                <table id="users-table"></table>
            </div>
        </div>

        <!-- 3. BOOKS (FULL EDIT) -->
        <div id="books" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Ù¾Û•Ø±ØªÙˆÙˆÚ©Û•Ú©Ø§Ù†</h2>
                <button class="btn btn-primary btn-sm" onclick="admin.openBookModal()">+ Ø²ÛØ¯Û•Ú©Ø±Ù†</button>
            </div>
            <input type="text" class="input" placeholder="Ù„ÛÚ¯Û•Ø±ÛŒØ§Ù†..." oninput="admin.searchBook(this.value)" style="margin-bottom:15px;">
            <div class="table-responsive card">
                <table id="books-table"></table>
            </div>
        </div>

        <!-- 4. LIBRARIES -->
        <div id="libraries" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û•Ú©Ø§Ù†</h2>
                <button class="btn btn-success btn-sm" onclick="admin.openLibModal()">+ Ø²ÛØ¯Û•Ú©Ø±Ù†</button>
            </div>
            <div id="lib-list" style="display:grid; gap:15px;"></div>
        </div>

        <!-- 5. MARKETING (POINTS RULES & NOTIFICATIONS) -->
        <div id="marketing" class="section">
            <h2>Ù…Ø§Ø±Ú©ÛØªÛŒÙ†Ú¯ & Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†</h2>
            
            <!-- Dynamic Points System -->
            <div class="card" style="margin-top:20px;">
                <h3 style="margin-bottom:15px; color:var(--accent);">â­ Ú•ÛÚ©Ø®Ø³ØªÙ†Ø§ Ø®Ø§ÚµØ§Ù† (Dynamic)</h3>
                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">Ù„ÛØ±Û• ÛŒØ§Ø³Ø§ÛŒÛÙ† Ø®Ø§ÚµØ§Ù† Ø¯Ø§Ù†Û (Ú†Û•Ù†Ø¯ Ø®Ø§Úµ Ø¯Ø¨Ù†Û• Ú†Û•Ù†Ø¯ Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†):</p>
                <div id="points-rules-container" style="margin-bottom:15px; display:flex; flex-wrap:wrap;">
                    <!-- JS Fills this -->
                </div>
                <div class="grid-2">
                    <input type="number" id="new-rule-pts" class="input" placeholder="Ø®Ø§Úµ (Ù…Û•Ø³Û•Ù„Û•Ù†: 100)">
                    <input type="number" id="new-rule-disc" class="input" placeholder="Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† (0.05 ÙˆØ§ØªÛ• 5%)">
                </div>
                <button class="btn btn-warning" onclick="admin.addPointRule()" style="margin-top:10px;">Ø²ÛØ¯Û•Ú©Ø±Ù†Ø§ ÛŒØ§Ø³Ø§ÛŒÛ</button>
            </div>

            <!-- Targeted Notification -->
            <div class="card">
                <h3>ğŸ”” Ù‡Ù†Ø§Ø±ØªÙ†Ø§ Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒ</h3>
                <div class="form-group">
                    <label>Ø¬Û†Ø±Û Ù‡Ù†Ø§Ø±ØªÙ†Û</label>
                    <select id="notif-type" class="input" onchange="toggleNotifInput()">
                        <option value="all">Ø¨Û† Ù‡Û•Ù…ÛŒØ§Ù† (All Users)</option>
                        <option value="single">Ø¨Û† Ú©Û•Ø³Û•Ú©Û ØªØ§ÛŒØ¨Û•Øª (Single)</option>
                        <option value="limit">Ø¨Û† (X) Ú©Û•Ø³ÛÙ† Ú†Ø§Ù„Ø§Ú©</option>
                    </select>
                </div>
                
                <!-- Hidden inputs based on selection -->
                <div class="form-group" id="target-single-div" style="display:none;">
                    <label>Ú˜Ù…Ø§Ø±Ø§ Ù…Û†Ø¨Ø§ÛŒÙ„Ø§ Ú©Û•Ø³ÛŒ</label>
                    <input type="text" id="notif-single-phone" class="input" placeholder="07xxxxxxxxx">
                </div>
                <div class="form-group" id="target-limit-div" style="display:none;">
                    <label>Ú˜Ù…Ø§Ø±Ø§ Ú©Û•Ø³Ø§Ù†</label>
                    <input type="number" id="notif-count" class="input" placeholder="50">
                </div>

                <div class="form-group">
                    <label>Ù¾Û•ÛŒØ§Ù…</label>
                    <textarea id="notif-msg" class="input" rows="3" placeholder="Ù†Ø§Ú¤Û•Ø±Û†Ú©Ø§ Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒÛ..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="admin.sendNotif()"><i class="fas fa-paper-plane"></i> Ù‡Ù†Ø§Ø±ØªÙ†</button>
            </div>
            
            <div class="card">
                <h3>ğŸŸï¸ Ú©Û†Ø¯ÛÙ† Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†Û</h3>
                <div class="grid-2">
                    <input type="text" id="coupon-code" class="input" placeholder="Ú©Û†Ø¯ (RAMAZAN)">
                    <input type="number" id="coupon-val" class="input" placeholder="Ú•ÛÚ˜Û• (0.10)">
                </div>
                <button class="btn btn-success" onclick="admin.addCoupon()">Ø²ÛØ¯Û•Ú©Ø±Ù†</button>
            </div>
        </div>

        <!-- 6. SETTINGS (CITIES) -->
        <div id="settings" class="section">
            <h2>Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ù†Ø§ Ø¨Ø§Ú˜ÛÚ•Ø§Ù† (Locations)</h2>
            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-city" class="input" placeholder="Ù†Ø§Ú¤Û Ø¨Ø§Ú˜ÛÚ•Û Ù†ÙˆÛŒ">
                    <button class="btn btn-success btn-sm" onclick="admin.addCity()">Ø²ÛØ¯Û•Ú©Ø±Ù†</button>
                </div>
                <div id="cities-container" style="display:flex; flex-wrap:wrap;"></div>
            </div>
        </div>

    </div>

    <!-- === MODALS === -->

    <!-- 1. ORDER DETAILS MODAL (ADDED NEW) -->
    <div id="order-modal" class="modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                <h3>ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒÛÙ† Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛ <span id="vo-id" style="color:var(--primary);">#ID</span></h3>
                <i class="fas fa-times" onclick="closeModal('order-modal')" style="cursor:pointer; font-size:1.2rem; color:var(--danger);"></i>
            </div>

            <div class="verify-code-display">
                <div style="margin-bottom:5px; color:var(--success);">Ú©Û†Ø¯Û ÙˆÛ•Ø±Ú¯Ø±ØªÙ†Û (Verification Code)</div>
                <div class="verify-code-val" id="vo-code">----</div>
            </div>

            <div class="order-info-grid">
                <div class="info-row"><i class="fas fa-user"></i> <b id="vo-name">Name</b></div>
                <div class="info-row"><i class="fas fa-phone"></i> <b id="vo-phone">07xxxx</b></div>
                <div class="info-row"><i class="fas fa-map-marker-alt"></i> <span id="vo-address">Address</span></div>
                <div class="info-row"><i class="fas fa-city"></i> <span id="vo-city">City</span></div>
            </div>

            <h4 style="margin-bottom:10px; color:var(--text-muted);">Ù„ÛŒØ³ØªØ§ Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø§Ù†</h4>
            <div id="vo-items" style="max-height:200px; overflow-y:auto; margin-bottom:15px;"></div>

            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
                <div style="display:flex; justify-content:space-between;"><span>Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†:</span> <span id="vo-delivery">0</span></div>
                <div style="display:flex; justify-content:space-between; color:var(--danger);"><span>Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†:</span> <span id="vo-discount">0</span></div>
                <div style="display:flex; justify-content:space-between; font-size:1.3rem; font-weight:900; color:var(--success); margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                    <span>Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ:</span> <span id="vo-total">0 IQD</span>
                </div>
            </div>

            <div style="margin-top:25px; display:flex; gap:10px;">
                <button class="btn btn-success" style="flex:1;" onclick="admin.updateOrderStatus('approved')">âœ… Ù‚Û•Ø¨ÙˆÚµÚ©Ø±Ù†</button>
                <button class="btn btn-info" style="flex:1;" onclick="admin.updateOrderStatus('delivered')">ğŸšš Ú¯Û•Ù‡Ø§Ù†Ø¯Ù† (ØªÛ•Ù…Ø§Ù…)</button>
                <button class="btn btn-danger" style="flex:1;" onclick="admin.deleteCurrentOrder()">ğŸ—‘ï¸ Ú˜ÛØ¨Ø±Ù†</button>
            </div>
        </div>
    </div>

    <!-- 2. USER DETAILS MODAL -->
    <div id="user-details-modal" class="modal">
        <div class="modal-box" style="width:100%; max-width:700px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>Ù¾Ú•Û†ÙØ§ÛŒÙ„ & Ú©Û†Ù†ØªØ±Û†Úµ</h3>
                <i class="fas fa-times" onclick="closeModal('user-details-modal')" style="cursor:pointer;"></i>
            </div>
            
            <div class="grid-2">
                <!-- Editable Profile -->
                <div class="card">
                    <h4 style="margin-bottom:10px; color:var(--primary);">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ú©Û•Ø³ÛŒ (Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ)</h4>
                    <div class="form-group"><label>Ù†Ø§Ú¤</label><input type="text" id="ud-name-edit" class="input"></div>
                    <div class="form-group"><label>Ù…Û†Ø¨Ø§ÛŒÙ„</label><input type="text" id="ud-phone-edit" class="input"></div>
                    <div class="form-group"><label>Ø¨Ø§Ú˜ÛÚ•</label><input type="text" id="ud-city-edit" class="input"></div>
                    <div class="form-group"><label>Ù†Ø§Ú¤Ù†ÛŒØ´Ø§Ù†</label><input type="text" id="ud-address-edit" class="input"></div>
                    
                    <div class="grid-2">
                        <button class="btn btn-warning btn-sm" onclick="admin.saveUserEdits()">Ù†ÙˆÛÚ©Ø±Ù†</button>
                        <button class="btn btn-danger btn-sm" onclick="admin.deleteUser()">Ú˜ÛØ¨Ø±Ù†Ø§ Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛŒ</button>
                    </div>
                </div>

                <!-- Points Control -->
                <div class="card" style="text-align:center;">
                    <h1 id="ud-points" style="color:var(--accent);">0</h1>
                    <small>Ø®Ø§ÚµÛÙ† Ù…Ø§ÛŒÙ†</small>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <input type="number" id="ud-mod-points" class="input" style="padding:5px;" placeholder="250">
                        <button class="btn btn-success btn-sm" onclick="admin.modUserPoints('add')">+</button>
                        <button class="btn btn-danger btn-sm" onclick="admin.modUserPoints('sub')">-</button>
                    </div>
                </div>
            </div>

            <h4 style="margin:15px 0;">Ù…ÛÚ˜ÙˆÙˆÛŒØ§ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒØ§Ù† & Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ</h4>
            <div style="margin-bottom:10px; font-weight:bold; color:var(--success);">
                Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ Ú©Ú•ÛŒÙ†Û: <span id="ud-total-spent">0</span> IQD
            </div>
            <div class="table-responsive card">
                <table id="ud-orders-table"></table>
            </div>
        </div>
    </div>

    <!-- 3. BOOK MODAL -->
    <div id="book-modal" class="modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3><i class="fas fa-book"></i> Ø²ÛØ¯Û•Ú©Ø±Ù† / Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ</h3>
                <i class="fas fa-times" onclick="closeModal('book-modal')" style="cursor:pointer; color:var(--danger);"></i>
            </div>
            <input type="hidden" id="b-id">
            
            <div class="form-group"><label>Ù†Ø§Ú¤Û Ù¾Û•Ø±ØªÙˆÙˆÚ©Û</label><input type="text" id="b-title" class="input"></div>
            <div class="grid-2">
                <div class="form-group"><label>Ù†Ú¤ÛŒØ³Û•Ø±</label><input type="text" id="b-author" class="input"></div>
                <div class="form-group"><label>Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û•</label><select id="b-lib" class="input"></select></div>
            </div>
            
            <div class="grid-2">
                <div class="form-group"><label>Ù†Ø±Ø® (ØªØ§Ú©)</label><input type="number" id="b-price" class="input"></div>
                <div class="form-group"><label>Ù†Ø±Ø® (Ø¦Û•Ø³ÚµÛŒ - Ø¨Û† Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†)</label><input type="number" id="b-orig-price" class="input" placeholder="Ø¦Û•Ú¯Û•Ø± Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† Ù‡Û•Ø¨ÛŒØª"></div>
            </div>

            <div class="card" style="padding:10px; border:1px dashed var(--accent);">
                <label style="color:var(--accent);">Ø¬ÙˆÙ…Ù„Û• (Wholesale)</label>
                <div class="grid-2">
                    <div class="input-group"><label>Ú˜Ù…Ø§Ø±Û• (Qty)</label><input type="number" id="b-bulk-qty" class="input" placeholder="10"></div>
                    <div class="input-group"><label>Ù†Ø±Ø®Û Ú©Û†Ù… (Price)</label><input type="number" id="b-bulk-price" class="input" placeholder="4000"></div>
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group"><label>Ù„Ø§Ù¾Û•Ú•</label><input type="text" id="b-pages" class="input"></div>
                <div class="form-group"><label>ØªÛ•Ø­Ù‚ÛŒÙ‚</label><input type="text" id="b-tahqiq" class="input"></div>
                <div class="form-group"><label>Ø¨Û•Ø±Ú¯ (Vol)</label><input type="text" id="b-volumes" class="input"></div>
                <div class="form-group"><label>Ú©Ø§ØºÛ•Ø²</label><input type="text" id="b-paper" class="input"></div>
            </div>

            <div class="form-group"><label>Ù¾ÙˆØ®ØªÛ•</label><textarea id="b-desc" class="input" rows="3"></textarea></div>
            <div class="form-group"><label>ÙˆÛÙ†Û Ø³Û•Ø±Û•Ú©ÛŒ (URL)</label><input type="text" id="b-img" class="input"></div>
            <div class="form-group"><label>ÙˆÛÙ†ÛÙ† Ú†Ø§Ú¤Ø®Ø´Ø§Ù†Ø¯Ù†Û (URLs - Ù‡Û•Ø± Ù‡ÛÚµÛ•Ú© ÙˆÛÙ†Û•ÛŒÛ•Ú©)</label><textarea id="b-preview-imgs" class="input" rows="3"></textarea></div>

            <button class="btn btn-primary" onclick="admin.saveBook()">Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ù†</button>
        </div>
    </div>

    <!-- 4. LIBRARY MODAL -->
    <div id="lib-modal" class="modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3><i class="fas fa-building"></i> Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û• & Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†</h3>
                <i class="fas fa-times" onclick="closeModal('lib-modal')" style="cursor:pointer; color:var(--danger);"></i>
            </div>
            
            <div class="form-group"><label>Ù†Ø§Ú¤</label><input type="text" id="l-name" class="input"></div>
            
            <!-- City Dropdown -->
            <div class="form-group">
                <label>Ø¨Ø§Ú˜ÛÚ• (Location)</label>
                <select id="l-city" class="input"></select>
            </div>

            <div class="form-group"><label>ÙˆÛÙ†Û• URL</label><input type="text" id="l-img" class="input"></div>
            <div class="form-group"><label>Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†Ø§ Ú¯Ø´ØªÛŒ (%)</label><input type="number" id="l-discount" class="input" placeholder="0"></div>

            <div class="card">
                <label>Ù†Ø±Ø®Û Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†Û (Ø¯ÛŒÙ†Ø§Ø±)</label>
                <div class="grid-2">
                    <div class="form-group"><label>Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†Ø§ Ù†Ø§ÙˆØ®Û† (Ù‡Û•Ù…Ø§Ù† Ø¨Ø§Ú˜ÛÚ•)</label><input type="number" id="l-local" class="input" placeholder="2000"></div>
                    <div class="form-group"><label>Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†Ø§ Ø¯Û•Ø±Û•Ú©ÛŒ (Ø¨Ø§Ú˜ÛÚ•ÛÙ† Ø¯ÛŒ)</label><input type="number" id="l-foreign" class="input" placeholder="5000"></div>
                </div>
                <div class="form-group"><label>Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†Ø§ Ø¨Û Ø¨Û•Ø±Ø§Ù…Ø¨Û•Ø± (Ø³Û•Ø±ÙˆÙˆÛŒ..)</label><input type="number" id="l-free" class="input" placeholder="50000"></div>
            </div>

            <button class="btn btn-success" onclick="admin.saveLib()">Ø²ÛØ¯Û•Ú©Ø±Ù† / Ù†ÙˆÛÚ©Ø±Ù†</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB8-7RLi1UbixK8d-LGmH-K-SfR-GaMZ2E",
            authDomain: "projeislambook.firebaseapp.com",
            projectId: "projeislambook",
            storageBucket: "projeislambook.firebasestorage.app",
            messagingSenderId: "577300732966",
            appId: "1:577300732966:web:df3000e0db45adf4e51ae7",
            measurementId: "G-SJ97S3FWYE"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const firestore = firebase.firestore();

        // UI HELPERS
        function toggleMenu() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }
        function nav(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            btn.classList.add('active');
            toggleMenu();
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function toggleNotifInput() {
            const val = document.getElementById('notif-type').value;
            document.getElementById('target-single-div').style.display = (val === 'single') ? 'block' : 'none';
            document.getElementById('target-limit-div').style.display = (val === 'limit') ? 'block' : 'none';
        }

        // ADMIN LOGIC
        let currentViewOrderId = null;

        const admin = {
            data: { orders: [], books: [], users: [], libs: [], cities: [], pointRules: [] },
            selectedUserId: null,

            init() {
                this.listen();
                this.loadCities();
                this.loadPointRules();
            },

            listen() {
                // Orders
                firestore.collection('orders').orderBy('id', 'desc').onSnapshot(snap => {
                    this.data.orders = [];
                    let revenue = 0;
                    snap.forEach(doc => {
                        const o = { docId: doc.id, ...doc.data() };
                        this.data.orders.push(o);
                        if(o.status === 'delivered') revenue += o.total;
                    });
                    document.getElementById('d-revenue').innerText = revenue.toLocaleString();
                    document.getElementById('d-orders').innerText = this.data.orders.length;
                    this.renderOrders();
                });

                // Users
                firestore.collection('users').onSnapshot(snap => {
                    this.data.users = [];
                    snap.forEach(doc => this.data.users.push({ docId: doc.id, ...doc.data() }));
                    document.getElementById('d-users').innerText = this.data.users.length;
                    this.renderUsers();
                });

                // Books
                firestore.collection('books').onSnapshot(snap => {
                    this.data.books = [];
                    snap.forEach(doc => this.data.books.push({ docId: doc.id, ...doc.data() }));
                    document.getElementById('d-books').innerText = this.data.books.length;
                    this.renderBooks();
                });

                // Libs
                firestore.collection('libraries').onSnapshot(snap => {
                    this.data.libs = [];
                    const sel = document.getElementById('b-lib');
                    sel.innerHTML = '';
                    snap.forEach(doc => {
                        const l = { docId: doc.id, ...doc.data() };
                        this.data.libs.push(l);
                        sel.innerHTML += `<option value="${l.id}">${l.name}</option>`;
                    });
                    this.renderLibs();
                });
            },

            // --- CITIES MANAGER ---
            async loadCities() {
                firestore.collection('settings').doc('locations').onSnapshot(doc => {
                    if(doc.exists) {
                        this.data.cities = doc.data().list || [];
                        this.renderCities();
                        this.updateLibCityDropdown();
                    }
                });
            },
            renderCities() {
                const con = document.getElementById('cities-container');
                con.innerHTML = this.data.cities.map(c => `
                    <div class="city-tag">
                        ${c} <i class="fas fa-times" style="cursor:pointer; color:red;" onclick="admin.removeCity('${c}')"></i>
                    </div>
                `).join('');
            },
            updateLibCityDropdown() {
                const sel = document.getElementById('l-city');
                sel.innerHTML = this.data.cities.map(c => `<option value="${c}">${c}</option>`).join('');
            },
            async addCity() {
                const c = document.getElementById('new-city').value;
                if(c) {
                    await firestore.collection('settings').doc('locations').set({
                        list: firebase.firestore.FieldValue.arrayUnion(c)
                    }, {merge:true});
                    document.getElementById('new-city').value = '';
                }
            },
            async removeCity(c) {
                if(confirm('Ú˜ÛØ¨Ø±Ù†ØŸ')) {
                    await firestore.collection('settings').doc('locations').update({
                        list: firebase.firestore.FieldValue.arrayRemove(c)
                    });
                }
            },

            // --- POINT RULES MANAGER ---
            async loadPointRules() {
                firestore.collection('settings').doc('points_rules_dynamic').onSnapshot(doc => {
                    if(doc.exists) {
                        this.data.pointRules = doc.data().rules || [];
                        this.renderPointRules();
                    }
                });
            },
            renderPointRules() {
                const con = document.getElementById('points-rules-container');
                con.innerHTML = this.data.pointRules.map((rule, index) => `
                    <div class="point-rule-tag">
                        ${rule.points} Ø®Ø§Úµ = ${rule.discount * 100}%
                        <i class="fas fa-times" style="cursor:pointer; color:red;" onclick="admin.removePointRule(${index})"></i>
                    </div>
                `).join('');
            },
            async addPointRule() {
                const pts = Number(document.getElementById('new-rule-pts').value);
                const disc = Number(document.getElementById('new-rule-disc').value);
                
                if(pts && disc) {
                    const newRule = { points: pts, discount: disc };
                    // Add to local array then save
                    const updatedRules = [...this.data.pointRules, newRule];
                    await firestore.collection('settings').doc('points_rules_dynamic').set({ rules: updatedRules });
                    document.getElementById('new-rule-pts').value = '';
                    document.getElementById('new-rule-disc').value = '';
                }
            },
            async removePointRule(index) {
                const updatedRules = this.data.pointRules.filter((_, i) => i !== index);
                await firestore.collection('settings').doc('points_rules_dynamic').set({ rules: updatedRules });
            },

            // --- USERS & FULL DETAILS (ADDED EDIT/DELETE) ---
            renderUsers() {
                const tbody = document.getElementById('users-table');
                tbody.innerHTML = `<thead><tr><th>Ù†Ø§Ú¤</th><th>Ù…Û†Ø¨Ø§ÛŒÙ„</th><th>Ø®Ø§Úµ</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead><tbody>` + 
                this.data.users.slice(0, 50).map(u => `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.phone}</td>
                        <td style="color:var(--accent); font-weight:bold;">${u.points || 0}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="admin.openUserDetails('${u.docId}')">ØªÛ•ÙØ§Ø³ÛŒÙ„</button></td>
                    </tr>
                `).join('') + `</tbody>`;
            },

            async openUserDetails(docId) {
                // Find user by docId (Firestore ID)
                this.selectedUserId = docId;
                const u = this.data.users.find(x => x.docId === docId);
                
                if(!u) return alert("Ø¨Ú©Ø§Ø±Ø¦ÛŒÙ†Û•Ø± Ù†Û•Ù‡Ø§ØªÛ• Ø¯ÛŒØªÙ†!");

                // Populate Editable Fields
                document.getElementById('ud-name-edit').value = u.name;
                document.getElementById('ud-phone-edit').value = u.phone;
                document.getElementById('ud-city-edit').value = u.city || '';
                document.getElementById('ud-address-edit').value = u.address || '';
                document.getElementById('ud-points').innerText = u.points || 0;

                // Fetch Orders for this user (using Phone as ID)
                const snap = await firestore.collection('orders').where('userId', '==', u.phone).get();
                const orders = [];
                let totalSpent = 0;
                snap.forEach(doc => {
                    const o = doc.data();
                    orders.push(o);
                    if(o.status === 'delivered') totalSpent += o.total;
                });

                document.getElementById('ud-total-spent').innerText = totalSpent.toLocaleString();

                const table = document.getElementById('ud-orders-table');
                table.innerHTML = `<thead><tr><th>#ID</th><th>Ù¾Ø§Ø±Û•</th><th>Ú•Û•ÙˆØ´</th><th>Ú©Ú•ÛŒÙ†</th></tr></thead><tbody>` +
                orders.map(o => `
                    <tr>
                        <td>#${o.id.toString().slice(-6)}</td>
                        <td>${o.total.toLocaleString()}</td>
                        <td>${o.status}</td>
                        <td>${o.items.length} Ø¯Ø§Ù†Û•</td>
                    </tr>
                `).join('') + `</tbody>`;

                document.getElementById('user-details-modal').style.display = 'flex';
            },

            async saveUserEdits() {
                const name = document.getElementById('ud-name-edit').value;
                const phone = document.getElementById('ud-phone-edit').value;
                const city = document.getElementById('ud-city-edit').value;
                const address = document.getElementById('ud-address-edit').value;
                
                await firestore.collection('users').doc(this.selectedUserId).update({
                    name, phone, city, address
                });
                alert("Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù†ÙˆÛ Ø¨ÙˆÙˆÙ† âœ…");
            },

            async deleteUser() {
                if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØŸ Ø¦Û•Ú©Ø§ÙˆÙ†Øª Ø¯Û Ø¨ ÛŒÛ•Ú©Ø¬Ø§Ø±ÛŒ Ù‡ÛØªÛ• Ú˜ÛØ¨Ø±Ù†! âš ï¸")) {
                    await firestore.collection('users').doc(this.selectedUserId).delete();
                    alert("Ø¦Û•Ú©Ø§ÙˆÙ†Øª Ù‡Ø§ØªÛ• Ú˜ÛØ¨Ø±Ù† ğŸ—‘ï¸");
                    closeModal('user-details-modal');
                }
            },

            async modUserPoints(type) {
                const val = Number(document.getElementById('ud-mod-points').value);
                if(!val) return;
                const amount = type === 'add' ? val : -val;
                await firestore.collection('users').doc(this.selectedUserId).update({
                    points: firebase.firestore.FieldValue.increment(amount)
                });
                alert("Ø®Ø§Úµ Ù†ÙˆÛ Ø¨ÙˆÙˆÙ† âœ…");
                const current = Number(document.getElementById('ud-points').innerText);
                document.getElementById('ud-points').innerText = current + amount;
            },

            // --- LIBRARIES ---
            openLibModal() { document.getElementById('lib-modal').style.display = 'flex'; },
            async saveLib() {
                const lib = {
                    id: Date.now(),
                    name: document.getElementById('l-name').value,
                    city: document.getElementById('l-city').value,
                    img: document.getElementById('l-img').value,
                    discountPercent: Number(document.getElementById('l-discount').value) || 0,
                    localPrice: Number(document.getElementById('l-price-local').value) || 0,
                    foreignPrice: Number(document.getElementById('l-price-foreign').value) || 0,
                    freeDeliveryLimit: Number(document.getElementById('l-free').value) || 0
                };
                await firestore.collection('libraries').add(lib);
                closeModal('lib-modal');
            },
            renderLibs() {
                document.getElementById('lib-list').innerHTML = this.data.libs.map(l => `
                    <div class="card" style="display:flex; gap:15px; align-items:center;">
                        <img src="${l.img}" style="width:50px; height:50px; border-radius:50%;">
                        <div style="flex:1;">
                            <b>${l.name}</b> (${l.city})<br>
                            <small class="text-muted">Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†: ${l.discountPercent}% | Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†: ${l.localPrice}/${l.foreignPrice}</small>
                        </div>
                        <button class="btn btn-danger btn-sm" style="width:auto;" onclick="admin.delLib('${l.docId}')">X</button>
                    </div>
                `).join('');
            },
            async delLib(id) { if(confirm('Ú˜ÛØ¨Ø±Ù†ØŸ')) await firestore.collection('libraries').doc(id).delete(); },

            // --- BOOKS ---
            renderBooks() {
                document.getElementById('books-table').innerHTML = `<thead><tr><th>ÙˆÛÙ†Û•</th><th>Ù†Ø§Ú¤</th><th>Ù†Ø±Ø®</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead><tbody>` + 
                this.data.books.map(b => `
                    <tr>
                        <td><img src="${b.img}" style="width:40px; height:50px; border-radius:5px;"></td>
                        <td>${b.title}</td>
                        <td>${b.price}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="admin.editBook('${b.docId}')"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="admin.delBook('${b.docId}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('') + `</tbody>`;
            },
            openBookModal() {
                document.getElementById('b-id').value = '';
                document.querySelectorAll('#book-modal input, #book-modal textarea').forEach(i => i.value = '');
                document.getElementById('book-modal').style.display = 'flex';
            },
            editBook(docId) {
                const b = this.data.books.find(x => x.docId === docId);
                document.getElementById('b-id').value = docId;
                document.getElementById('b-title').value = b.title;
                document.getElementById('b-author').value = b.author;
                document.getElementById('b-price').value = b.price;
                document.getElementById('b-orig-price').value = b.originalPrice || '';
                document.getElementById('b-lib').value = b.libId;
                document.getElementById('b-bulk-qty').value = b.bulkQty || '';
                document.getElementById('b-bulk-price').value = b.bulkPrice || '';
                document.getElementById('b-pages').value = b.pages || '';
                document.getElementById('b-tahqiq').value = b.tahqiq || '';
                document.getElementById('b-volumes').value = b.volumes || '';
                document.getElementById('b-paper').value = b.paper || '';
                document.getElementById('b-desc').value = b.desc || '';
                document.getElementById('b-img').value = b.img || '';
                document.getElementById('b-preview-imgs').value = b.previewImages ? b.previewImages.join('\n') : '';
                document.getElementById('book-modal').style.display = 'flex';
            },
            async saveBook() {
                const docId = document.getElementById('b-id').value;
                const prev = document.getElementById('b-preview-imgs').value.split('\n').map(x=>x.trim()).filter(x=>x);
                const data = {
                    title: document.getElementById('b-title').value,
                    author: document.getElementById('b-author').value,
                    price: Number(document.getElementById('b-price').value),
                    originalPrice: Number(document.getElementById('b-orig-price').value) || 0,
                    libId: Number(document.getElementById('b-lib').value),
                    bulkQty: Number(document.getElementById('b-bulk-qty').value) || 0,
                    bulkPrice: Number(document.getElementById('b-bulk-price').value) || 0,
                    pages: document.getElementById('b-pages').value,
                    tahqiq: document.getElementById('b-tahqiq').value,
                    volumes: document.getElementById('b-volumes').value,
                    paper: document.getElementById('b-paper').value,
                    desc: document.getElementById('b-desc').value,
                    img: document.getElementById('b-img').value,
                    previewImages: prev,
                    cat: 'General'
                };
                if(docId) await firestore.collection('books').doc(docId).update(data);
                else { data.id = Date.now(); await firestore.collection('books').add(data); }
                closeModal('book-modal');
                alert("ØªÛ•Ù…Ø§Ù…Û• âœ…");
            },
            async delBook(id) { if(confirm('Ú˜ÛØ¨Ø±Ù†ØŸ')) await firestore.collection('books').doc(id).delete(); },

            // --- NOTIFICATIONS (Targeted) ---
            async sendNotif() {
                const type = document.getElementById('notif-type').value;
                const msg = document.getElementById('notif-msg').value;
                
                if(!msg) return alert("Ù¾Û•ÛŒØ§Ù… Ø¨Û•ØªØ§ÚµÛ•!");

                const data = { text: msg, time: new Date().toLocaleTimeString(), read: false };

                if(type === 'all') {
                    await firestore.collection('notifications').add(data);
                    alert("Ø¨Û† Ù‡Û•Ù…ÛŒØ§Ù† Ú†ÙˆÙˆ");
                } else if(type === 'single') {
                    const phone = document.getElementById('notif-single-phone').value;
                    if(!phone) return alert("Ú˜Ù…Ø§Ø±Ø§ Ù…Û†Ø¨Ø§ÛŒÙ„Û Ø¨Ù†Ú¤ÛŒØ³Û•!");
                    data.targetPhone = phone;
                    await firestore.collection('notifications').add(data);
                    alert("Ø¨Û† " + phone + " Ú†ÙˆÙˆ");
                } else if(type === 'limit') {
                    const limit = Number(document.getElementById('notif-count').value);
                    const users = [...this.data.users].sort((a,b) => (b.points||0)-(a.points||0)).slice(0, limit);
                    const batch = firestore.batch();
                    users.forEach(u => {
                        const ref = firestore.collection('notifications').doc();
                        batch.set(ref, { ...data, targetPhone: u.phone });
                    });
                    await batch.commit();
                    alert(`Ø¨Û† ${limit} Ú©Û•Ø³Ø§Ù† Ú†ÙˆÙˆ`);
                }
            },
            async addCoupon() {
                // FIXED: Capitalize coupon code automatically
                const code = document.getElementById('coupon-code').value.toUpperCase();
                const val = Number(document.getElementById('coupon-val').value);
                if(code && val) {
                    await firestore.collection('coupons').doc(code).set({ discount: val });
                    alert("Ú©Û†Ø¯ Ø²ÛŒØ§Ø¯ Ø¨ÙˆÙˆ âœ…");
                }
            },

            // --- ORDERS (Table & Actions - UPDATED) ---
            renderOrders() {
                const html = this.data.orders.map(o => `
                    <tr>
                        <td>#${o.id.toString().slice(-6)}</td>
                        <td>${o.userName}<br><small>${o.userId}</small></td>
                        <td style="color:var(--success); font-weight:bold;">${o.total.toLocaleString()}</td>
                        <td>${o.userCity || '-'}</td>
                        <td><span style="padding:2px 8px; border-radius:5px; background:${o.status==='waiting'?'#F59E0B':o.status==='approved'?'#10B981':'#3b82f6'}; color:white; font-size:0.8rem;">${o.status}</span></td>
                        <td>
                            <!-- NEW: View Details Button -->
                            <button class="btn-info btn-sm" onclick="admin.viewOrder('${o.docId}')">ğŸ‘ï¸ ØªÛ•ÙØ§Ø³ÛŒÙ„</button>
                        </td>
                        <td>
                            <button class="btn-success btn-sm" onclick="admin.setStatus('${o.docId}', 'approved')">âœ“</button>
                            <button class="btn-danger btn-sm" onclick="admin.delOrder('${o.docId}')">X</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('dash-orders-table').innerHTML = `<thead><tr><th>ID</th><th>Ú©Û•Ø³</th><th>Ù¾Ø§Ø±Û•</th><th>Ø¨Ø§Ú˜ÛÚ•</th><th>Ú•Û•ÙˆØ´</th><th>ØªÛ•ÙØ§Ø³ÛŒÙ„</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead><tbody>${html}</tbody>`;
            },
            
            // --- NEW: VIEW ORDER LOGIC ---
            viewOrder(docId) {
                const o = this.data.orders.find(x => x.docId === docId);
                if(!o) return;
                currentViewOrderId = docId;

                document.getElementById('vo-id').innerText = '#' + o.id;
                document.getElementById('vo-code').innerText = o.code || '----';
                document.getElementById('vo-name').innerText = o.userName;
                document.getElementById('vo-phone').innerText = o.userId;
                document.getElementById('vo-address').innerText = o.userAddress;
                document.getElementById('vo-city').innerText = o.userCity || '-';

                // Items List
                document.getElementById('vo-items').innerHTML = o.items.map(i => `
                    <div class="receipt-item">
                        <div style="display:flex; align-items:center;">
                            <img src="${i.img}" class="item-img" onerror="this.src='https://via.placeholder.com/50'">
                            <div style="margin-left:10px;">
                                <div>${i.title}</div>
                                <small style="color:#aaa;">${i.price.toLocaleString()} IQD</small>
                            </div>
                        </div>
                        <div style="font-weight:bold;">x${i.qty}</div>
                    </div>
                `).join('');

                // Financials
                const delivery = o.deliveryFee || 0;
                // Reverse calc for display if needed, or simple subtraction
                const subtotal = o.items.reduce((a,b)=>a+(b.price*b.qty),0);
                const discount = (subtotal + delivery) - o.total;

                document.getElementById('vo-delivery').innerText = delivery.toLocaleString() + ' IQD';
                document.getElementById('vo-discount').innerText = discount > 0 ? '-' + discount.toLocaleString() + ' IQD' : '0 IQD';
                document.getElementById('vo-total').innerText = o.total.toLocaleString() + ' IQD';

                document.getElementById('order-modal').style.display = 'flex';
            },

            updateOrderStatus(status) {
                if(currentViewOrderId) {
                    this.setStatus(currentViewOrderId, status);
                    closeModal('order-modal');
                }
            },
            deleteCurrentOrder() {
                if(currentViewOrderId) {
                    this.delOrder(currentViewOrderId);
                    closeModal('order-modal');
                }
            },

            async setStatus(id, st) { await firestore.collection('orders').doc(id).update({status: st}); },
            async delOrder(id) { if(confirm('Ú˜ÛØ¨Ø±Ù†ØŸ')) await firestore.collection('orders').doc(id).delete(); },

            searchUser(val) {
                const filtered = this.data.users.filter(u => u.phone.includes(val) || u.name.includes(val));
                const tbody = document.getElementById('users-table');
                tbody.innerHTML = `<thead><tr><th>Ù†Ø§Ú¤</th><th>Ù…Û†Ø¨Ø§ÛŒÙ„</th><th>Ø®Ø§Úµ</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead><tbody>` + 
                filtered.map(u => `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.phone}</td>
                        <td style="color:var(--accent); font-weight:bold;">${u.points || 0}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="admin.openUserDetails('${u.docId}')">ØªÛ•ÙØ§Ø³ÛŒÙ„</button></td>
                    </tr>
                `).join('') + `</tbody>`;
            },
            searchBook(val) {
                const rows = document.querySelectorAll('#books-table tr');
                rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(val.toLowerCase()) ? '' : 'none');
            }
        };

        admin.init();
    </script>
</body>
</html>
