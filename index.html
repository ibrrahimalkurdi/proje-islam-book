
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Proje Islam Library</title>
    
    <!-- PWA Setup -->
    <meta name="theme-color" content="#1e3799">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Vazirmatn:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script> <!-- Added Messaging -->

    <style>
        :root {
            --primary: #1e3799;       
            --primary-dark: #0c2461;
            --accent: #f6b93b;        
            --bg-body: #f1f2f6;
            --bg-card: #ffffff;
            --text-main: #2f3542;
            --text-light: #a4b0be;
            --border-color: #eee;
            --danger: #eb4d4b;
            --success: #2ecc71;
            --warning: #f1c40f;
            --info: #3498db;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --header-h: 70px;
            --nav-h: 80px;
            --story-gradient: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            --discount-gradient: linear-gradient(45deg, #ff0000 0%, #ff5252 100%);
        }

        [data-theme="dark"] {
            --primary: #4a69bd;       
            --primary-dark: #1e3799;
            --accent: #f8c291;        
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #f1f2f6;
            --text-light: #747d8c;
            --border-color: #333;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Vazirmatn', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { background: var(--bg-body); color: var(--text-main); overflow-x: hidden; padding-bottom: calc(var(--nav-h) + 20px); transition: background 0.3s, color 0.3s; }
        a { text-decoration: none; color: inherit; }
        
        /* --- LOADER & OFFLINE --- */
        #loader-overlay, #offline-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        #offline-overlay { z-index: 10000; display: none; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(0,0,0,0.1); border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .loading-text { font-weight: bold; color: var(--text-light); animation: pulse 1.5s infinite; }

        /* --- TOAST NOTIFICATION --- */
        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 6000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(30, 30, 30, 0.95); color: white; padding: 15px 20px; border-radius: 50px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: 0.3s; backdrop-filter: blur(5px); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-icon { width: 25px; height: 25px; background: var(--success); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; }
        .toast-icon.error { background: var(--danger); }
        
        /* --- LIBRARIES STYLE --- */
        .stories-container { padding: 15px 20px; display: flex; gap: 20px; overflow-x: auto; scrollbar-width: none; margin-bottom: 5px; }
        .story-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.2s; position: relative; }
        .story-item:active { transform: scale(0.9); }
        .story-item.active-lib .story-ring { border-color: var(--success); box-shadow: 0 0 0 3px var(--success); background: none; }
        .story-item.has-discount .story-ring { background: var(--discount-gradient); animation: pulse-ring 2s infinite; }
        .discount-badge-story { position: absolute; top: 0; right: 0; background: red; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.7rem; border: 2px solid var(--bg-body); font-weight: bold; }
        .story-ring { width: 70px; height: 70px; border-radius: 50%; padding: 3px; background: var(--story-gradient); position: relative; transition: 0.3s; }
        .story-img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--bg-body); object-fit: cover; background: white; }
        .story-name { font-size: 0.75rem; max-width: 75px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); font-weight: 600; text-align: center; }
        
        /* --- SCREENS --- */
        .screen { display: none; min-height: 100vh; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: block; }

        /* --- AUTH MODAL --- */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); overflow-y: auto; }
        .auth-box { background: var(--bg-card); width: 90%; max-width: 400px; padding: 30px; border-radius: 30px; color: var(--text-main); box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative; margin: 20px 0; max-height: 90vh; overflow-y: auto; }
        .auth-close { position: absolute; top: 15px; left: 15px; font-size: 1.2rem; cursor: pointer; color: var(--text-light); }
        .auth-logo { font-size: 3rem; color: var(--primary); margin-bottom: 20px; text-align: center; }
        .auth-input { width: 100%; padding: 15px; background: var(--bg-body); color: var(--text-main); border: 2px solid transparent; border-radius: 15px; margin-bottom: 15px; font-size: 1rem; transition: 0.3s; }
        .auth-input:focus { border-color: var(--primary); background: var(--bg-card); }
        .radio-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .radio-label { flex: 1; background: var(--bg-body); padding: 12px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s; color: var(--text-light); }
        .radio-input { display: none; }
        .radio-input:checked + .radio-label { background: var(--bg-card); border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .btn-auth { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 800; font-size: 1.1rem; cursor: pointer; box-shadow: 0 10px 20px rgba(30, 55, 153, 0.3); }
        
        /* --- VERIFY MODAL --- */
        #verify-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .verify-box { background: var(--bg-card); width: 90%; max-width: 350px; padding: 30px; border-radius: 25px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .code-input { letter-spacing: 10px; font-size: 2rem; text-align: center; font-weight: 900; color: var(--primary); }
        
        /* --- HEADER --- */
        header { position: sticky; top: 0; z-index: 100; background: var(--bg-card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05); height: var(--header-h); transition: background 0.3s; }
        .brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
        .brand-text { font-family: 'Amiri', serif; font-size: 1.4rem; font-weight: 700; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        [data-theme="dark"] .brand-text { background: linear-gradient(135deg, #fff 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .icon-btn { position: relative; width: 35px; height: 35px; border-radius: 50%; background: var(--bg-body); display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-main); font-size: 1rem; }
        
        #lang-selector { position: relative; display: inline-block; }
        .lang-dropdown { display: none; position: absolute; top: 40px; left: 0; background: var(--bg-card); box-shadow: var(--shadow); border-radius: 15px; overflow: hidden; z-index: 101; width: 120px; }
        .lang-dropdown.show { display: block; }
        .lang-opt { padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 0.9rem; text-align: center; color: var(--text-main); }

        #notif-dropdown { display: none; position: absolute; top: 60px; left: 20px; width: 280px; max-height: 400px; overflow-y: auto; background: var(--bg-card); box-shadow: var(--shadow); border-radius: 15px; z-index: 102; padding: 10px; }
        #notif-dropdown.show { display: block; }
        .notif-item { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: var(--text-main); }
        .notif-dot { position: absolute; top: -2px; right: -2px; width: 12px; height: 12px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg-card); display: none; }
        .notif-dot.show { display: block; }

        /* --- SEARCH & ADVANCED FILTER --- */
        .search-container { padding: 10px 20px 10px; display: flex; gap: 10px; align-items: center; }
        .search-box { position: relative; width: 100%; }
        .search-input { width: 100%; padding: 16px 50px 16px 20px; border-radius: 20px; border: none; background: var(--bg-card); color: var(--text-main); box-shadow: var(--shadow); font-size: 1rem; }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .sort-btn { background: var(--bg-card); width: 50px; height: 50px; border-radius: 15px; display: flex; justify-content: center; align-items: center; box-shadow: var(--shadow); color: var(--primary); font-size: 1.2rem; cursor: pointer; flex-shrink: 0; }
        
        /* New Filter Panel Styles */
        #filter-panel {
            background: var(--bg-card);
            padding: 15px;
            margin: 0 20px 15px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s;
            border: 1px solid var(--border-color);
        }
        .filter-input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-input { width: 100%; padding: 10px; background: var(--bg-body); border-radius: 10px; border: 1px solid var(--border-color); color: var(--text-main); font-size: 0.9rem; outline: none; }
        .filter-select { padding: 8px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); outline: none; font-size: 0.9rem; }

        .categories { display: flex; gap: 12px; overflow-x: auto; padding: 10px 20px; scrollbar-width: none; }
        .cat-chip { background: var(--bg-card); padding: 10px 20px; border-radius: 30px; white-space: nowrap; font-weight: 600; color: var(--text-light); border: 1px solid var(--border-color); transition: 0.3s; cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 5px 15px rgba(30, 55, 153, 0.3); }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .card { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); position: relative; transition: transform 0.2s; }
        .card:active { transform: scale(0.97); }
        .card-img-c { height: 180px; width: 100%; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; backdrop-filter: blur(4px); }
        .card-fav { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #ccc; cursor: pointer; z-index: 10; backdrop-filter: blur(4px); }
        .card-fav.active { color: var(--danger); animation: heartBeat 0.4s; }
        .lib-tag { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; font-size: 0.75rem; padding: 20px 10px 5px; display: flex; align-items: center; gap: 5px; }
        
        .card-body { padding: 12px; }
        .card-title { font-size: 0.95rem; font-weight: 700; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); }
        .card-author { font-size: 0.8rem; color: var(--text-light); margin-bottom: 10px; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; }
        .price { font-weight: 800; color: var(--primary); }
        .old-price { text-decoration: line-through; color: #999; font-size: 0.75rem; margin-left: 5px; }
        .discount-price { color: var(--danger); font-weight: 900; }
        .btn-add { width: 32px; height: 32px; background: var(--bg-body); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary); transition: 0.2s; }

        .request-box { margin: 20px; padding: 20px; background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px dashed var(--primary); text-align: center; }
        .req-input-row { display: flex; gap: 10px; margin-top: 15px; }
        .req-input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); }
        .btn-req { padding: 0 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; }

        /* --- PRODUCT MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 2000; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal.open { transform: translateY(0); }
        
        .modal-hero { height: 260px; width: 100%; position: relative; } 
        .modal-hero img { width: 100%; height: 100%; object-fit: cover; }
        .modal-hero-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent 60%, var(--bg-card)); }

        .modal-btn-row { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; pointer-events: none; z-index: 10; }
        .modal-btn-icon { background: rgba(255,255,255,0.9); width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.3rem; cursor: pointer; pointer-events: auto; color: var(--text-main); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .modal-content-container { background: var(--bg-card); border-radius: 30px 30px 0 0; margin-top: -30px; position: relative; padding: 30px 25px 120px 25px; min-height: 500px; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); }

        .m-header-info { text-align: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .m-cat-tag { background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; display: inline-block; }
        .m-lib-tag { background: #34495e; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; display: inline-block; margin-right:5px; }
        
        .m-title { font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin: 10px 0; line-height: 1.5; }
        .m-author { color: var(--text-light); font-size: 1rem; font-weight: 500; }

        .m-spec-box { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .m-spec-item { background: var(--bg-body); padding: 12px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; border: 1px solid var(--border-color); }
        .m-spec-icon { color: var(--primary); font-size: 1.1rem; }
        .m-spec-label { font-size: 0.75rem; color: var(--text-light); }
        .m-spec-val { font-weight: bold; color: var(--text-main); font-size: 0.9rem; text-align: center; }

        .m-desc-box { background: var(--bg-body); padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); margin-bottom: 25px; line-height: 2; color: var(--text-main); text-align: justify; font-size: 0.95rem; }

        .m-offers { background: rgba(46, 204, 113, 0.1); border: 1px solid var(--success); padding: 15px; border-radius: 15px; margin-bottom: 25px; }
        .m-offer-row { display: flex; gap: 10px; align-items: center; font-size: 0.9rem; margin-bottom: 8px; color: #1e8449; }
        .m-offer-row:last-child { margin-bottom: 0; }

        .related-books-section { margin-top: 30px; }
        .related-title { font-weight: bold; margin-bottom: 15px; color: var(--text-main); font-size: 1.1rem; border-right: 4px solid var(--primary); padding-right: 10px; }
        .related-scroll { display: flex; gap: 15px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
        .related-card { min-width: 110px; width: 110px; cursor: pointer; }
        .related-img { width: 110px; height: 160px; border-radius: 12px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .related-name { font-size: 0.8rem; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 8px; color: var(--text-main); }

        .modal-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); padding: 15px 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; z-index: 2001; }
        
        #preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 8000; display: none; overflow-y: auto; }
        .preview-header { position: sticky; top: 0; background: var(--bg-card); padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 8001; }
        .preview-content { padding: 20px; text-align: center; }
        .preview-page { width: 100%; max-width: 600px; margin-bottom: 20px; border-radius: 10px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        
        /* --- CART --- */
        .coupon-box { display: flex; gap: 10px; margin-top: 20px; }
        .coupon-input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-body); color: var(--text-main); }
        .btn-apply { padding: 0 20px; background: var(--primary-dark); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .cart-item { background: var(--bg-card); padding: 15px; border-radius: 15px; display: flex; gap: 15px; margin-bottom: 15px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .cart-img { width: 60px; height: 80px; border-radius: 10px; object-fit: cover; }
        .qty-control { display: flex; align-items: center; background: var(--bg-body); border-radius: 8px; padding: 2px; }
        .qty-btn { width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; color: var(--text-main); }
        
        .points-redeem-box {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white; padding: 15px; border-radius: 15px; margin-top: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .redeem-btn {
            background: white; color: #6c5ce7; border: none; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; cursor: pointer;
        }

        /* --- PROFILE --- */
        .profile-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 40px 20px 60px; text-align: center; color: white; border-radius: 0 0 40px 40px; position: relative; }
        .avatar-container { width: 100px; height: 100px; margin: 0 auto 15px; position: relative; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--accent); object-fit: cover; background: white; }
        .edit-fab { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; backdrop-filter: blur(5px); }
        .profile-card { background: var(--bg-card); width: 90%; margin: -40px auto 20px; border-radius: 20px; padding: 20px; box-shadow: var(--shadow); position: relative; }
        .info-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border-color); align-items: center; }
        .info-row:last-child { border: none; }
        .info-label { color: var(--text-light); font-size: 0.9rem; }
        .info-val { font-weight: 600; color: var(--text-main); }
        .edit-input { border: 1px solid var(--primary); background: var(--bg-body); padding: 5px 10px; border-radius: 8px; width: 60%; text-align: left; color: var(--text-main); font-weight: bold; }
        .edit-input:disabled { background: #e0e0e0; border-color: #ccc; color: #888; cursor: not-allowed; }

        .points-badge { background: var(--accent); color: black; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-top: 5px; display: inline-block; }

        .btn-logout-styled { width: 90%; margin: 0 auto 30px; padding: 15px; background: #fff0f0; border: 2px solid var(--danger); color: var(--danger); border-radius: 15px; font-weight: 800; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.2s; font-size: 1rem; }
        .btn-logout-styled:active { transform: scale(0.95); }

        .live-orders-container { padding: 0 20px; }
        .live-title { font-size: 1.1rem; color: var(--text-main); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; padding-right: 10px; border-right: 4px solid var(--primary); }
        
        .track-card { background: var(--bg-card); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 20px; position: relative; overflow: hidden; border: 1px solid var(--border-color); }
        .track-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-color); }
        .track-id { font-weight: 900; font-size: 1.1rem; color: var(--text-main); letter-spacing: 1px; }
        .track-date { font-size: 0.8rem; color: var(--text-light); }

        .track-status-badge { display: inline-block; padding: 8px 15px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; width: 100%; text-align: center; }
        .st-wait { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .st-done { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .st-del { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .st-cancel { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .track-items { font-size: 0.9rem; color: var(--text-main); line-height: 1.6; margin-bottom: 15px; }
        .track-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .track-total { font-weight: 900; color: var(--primary); font-size: 1.2rem; }
        
        .btn-confirm-order { width: 100%; padding: 10px; background: var(--success); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; animation: pulse 2s infinite; }
        .btn-cancel-order { width: 40px; height: 40px; background: rgba(235, 77, 75, 0.1); color: var(--danger); border-radius: 50%; border: 1px solid var(--danger); display: flex; justify-content: center; align-items: center; cursor: pointer; }

        /* --- NAV --- */
        .nav-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--bg-card); height: 70px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1000; }
        .nav-item { color: var(--text-light); font-size: 1.4rem; transition: 0.3s; position: relative; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; border-radius: 50%; }
        .nav-item.active { background: var(--primary); color: white; transform: translateY(-10px); box-shadow: 0 10px 20px rgba(30, 55, 153, 0.3); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.65rem; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid white; }
        
        /* --- BTNS --- */
        .btn { padding: 15px; border-radius: 15px; border: none; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 1rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; box-shadow: 0 8px 20px rgba(30, 55, 153, 0.25); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); width: 100%; margin-top: 10px; }
        .btn:active { transform: scale(0.98); }
        .hidden { display: none !important; }
        
        /* --- DELIVERY DESIGN --- */
        .delivery-box {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 0;
            margin: 20px 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .delivery-header {
            background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .delivery-body { padding: 20px; }
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); pointer-events: none; font-size: 1.2rem; }
        .delivery-select, .delivery-input { width: 100%; padding: 18px 50px 18px 20px; border-radius: 15px; border: 2px solid var(--border-color); font-size: 1rem; background: var(--bg-body); color: var(--text-main); transition: 0.3s; appearance: none; outline: none; }
        .delivery-select:focus, .delivery-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 4px rgba(30, 55, 153, 0.1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes heartBeat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- LOADING OVERLAY -->
    <div id="loader-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÛŒ Ø¨Ø§Ø±Ú©Ø±Ø¯Ù† Ø¯Ø§ØªØ§ÛŒÛ...</div>
    </div>

    <!-- OFFLINE OVERLAY -->
    <div id="offline-overlay">
        <i class="fas fa-wifi-slash" style="font-size:4rem; color:var(--text-light); margin-bottom:20px;"></i>
        <h3 style="color:var(--text-main);">Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª Ù†ÛŒÙ†Û•!</h3>
        <p style="color:var(--text-light);">ØªÚ©Ø§ÛŒÛ• Ø¯ÚµÙ†ÛŒØ§Ø¨Û• Ù„Û• Ù‡Û•Ø¨ÙˆÙˆÙ†ÛŒ Ù‡ÛÚµÛŒ Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª</p>
        <button class="btn btn-primary" onclick="window.location.reload()" style="margin-top:20px; width:auto; padding:10px 30px;">Ù†ÙˆÛÚ©Ø±Ù†Û•ÙˆÛ• ğŸ”„</button>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container"></div>
    
    <!-- PREVIEW MODAL -->
    <div id="preview-modal">
        <div class="preview-header">
            <div style="font-weight:bold; color:var(--text-main);" data-lang="preview">Ú†Ø§Ú¤Ø®Ø´Ø§Ù†Ø¯Ù† ğŸ“–</div>
            <div onclick="app.closePreview()" style="font-size:1.5rem; cursor:pointer;"><i class="fas fa-times"></i></div>
        </div>
        <div class="preview-content" id="preview-container"></div>
    </div>
    
    <!-- VERIFICATION MODAL -->
    <div id="verify-modal">
        <div class="verify-box">
            <h2 style="color:var(--text-main); margin-bottom:10px;" data-lang="enter_code">ØªÚ©Ø§ÛŒÛ• Ú©Û†Ø¯Û Ø¨Ù†Ú¤ÛŒØ³Û•</h2>
            <p style="color:var(--text-light); margin-bottom:20px; font-size:0.9rem;" data-lang="code_desc">Ú©Û†Ø¯ Ø¯ Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒØ§Ù† Ø¯Ø§ Ù‡Ø§ØªÛŒÛ• Ø¨Û† ØªÛ•.</p>
            <input type="tel" id="verify-input" class="auth-input code-input" maxlength="4" placeholder="XXXX">
            <button id="btn-submit-verify" class="btn btn-primary" onclick="app.submitVerify()" data-lang="confirm_btn">Ù¾Ø´ØªÚ•Ø§Ø³ØªÚ©Ø±Ù†</button>
            <button class="btn btn-outline" onclick="app.closeVerifyModal()" style="border:none; color:var(--text-light); margin-top:10px;">Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†</button>
        </div>
    </div>

    <!-- AUTH OVERLAY -->
    <div id="auth-overlay" class="hidden">
        <div class="auth-box">
            <div class="auth-close" onclick="app.toggleAuthOverlay()"><i class="fas fa-times"></i></div>
            <div class="auth-logo"><i class="fas fa-kaaba"></i></div>
            
            <div id="login-form">
                <h2 style="margin-bottom:20px; text-align:center;" data-lang="login">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±</h2>
                <input type="tel" id="login-phone" class="auth-input" placeholder="Ú˜Ù…Ø§Ø±Ø§ Ù…Û†Ø¨Ø§ÛŒÙ„Û (07xxxxxxxxx)" maxlength="11">
                <input type="password" id="login-pass" class="auth-input" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ (Password)">
                <button class="btn-auth" onclick="app.login()" data-lang="login_btn">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±</button>
                <p style="margin-top:15px; font-size:0.9rem; color:var(--text-light); text-align:center;">
                    <span data-lang="no_account">ØªÛ• Ù‡Û•Ú˜Ù…Ø§Ø± Ù†ÛŒÙ†Û•ØŸ</span> 
                    <span onclick="app.switchAuth('register')" style="color:var(--primary); cursor:pointer; font-weight:bold;" data-lang="create">Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ù†</span>
                </p>
            </div>
            
            <div id="register-form" class="hidden">
                <h2 style="margin-bottom:20px; text-align:center;" data-lang="new_account">Ù‡Û•Ú˜Ù…Ø§Ø±Ø§ Ù†ÙˆÛ</h2>
                <input type="text" id="reg-name" class="auth-input" placeholder="Ù†Ø§Ú¤Û Ø³ÛŒØ§Ù†ÛŒ">
                <input type="tel" id="reg-phone" class="auth-input" placeholder="Ú˜Ù…Ø§Ø±Ø§ Ù…Û†Ø¨Ø§ÛŒÙ„Û (07xxxxxxxxx)" maxlength="11">
                <input type="password" id="reg-pass" class="auth-input" placeholder="ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ (Password)">
                
                <div class="radio-group">
                    <input type="radio" name="gender" id="g-male" value="Kur" class="radio-input" checked>
                    <label for="g-male" class="radio-label">Ú©ÙˆÚ• <i class="fas fa-male"></i></label>
                    <input type="radio" name="gender" id="g-female" value="KeÃ§" class="radio-input">
                    <label for="g-female" class="radio-label">Ú©Ú† <i class="fas fa-female"></i></label>
                </div>
                
                <div style="display:flex; gap:10px;">
                    <input type="number" id="reg-age" class="auth-input" placeholder="Ú˜ÛŒ (Ø¹Û•Ù…Ø±)" style="flex:1;">
                    <select id="reg-city" class="auth-input" style="flex:2;">
                        <option value="Duhok">Ø¯Ù‡Û†Ú©</option>
                    </select>
                </div>

                <input type="text" id="reg-address" class="auth-input" placeholder="Ù†Ø§Ú¤Ù†ÛŒØ´Ø§Ù† (ØªØ§Ø®)">
                
                <button class="btn-auth" onclick="app.register()" data-lang="register_btn">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†</button>
                <p style="margin-top:15px; font-size:0.9rem; color:var(--text-light); text-align:center;">
                    <span data-lang="have_account">ØªÛ• Ù‡Û•Ú˜Ù…Ø§Ø± Ù‡Û•ÛŒÛ•ØŸ</span>
                    <span onclick="app.switchAuth('login')" style="color:var(--primary); cursor:pointer; font-weight:bold;" data-lang="login">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±</span>
                </p>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app">
        <header>
            <div class="brand">
                <i class="fas fa-quran" style="font-size:1.4rem; color:var(--accent);"></i>
                <span class="brand-text">proje islam library</span>
            </div>
            <div class="header-actions">
                <div id="lang-selector">
                    <div class="icon-btn" onclick="app.toggleLangMenu()"><i class="fas fa-globe"></i></div>
                    <div class="lang-dropdown" id="lang-menu">
                        <div class="lang-opt" onclick="app.setLang('arabic')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
                        <div class="lang-opt" onclick="app.setLang('badini')">BadÃ®nÃ®</div>
                        <div class="lang-opt" onclick="app.setLang('sorani')">Ø³Û†Ø±Ø§Ù†ÛŒ</div>
                    </div>
                </div>
                <div style="position:relative;">
                    <div class="icon-btn" onclick="app.toggleNotif()">
                        <i class="far fa-bell"></i>
                        <div id="notif-dot" class="notif-dot"></div>
                    </div>
                    <div id="notif-dropdown"></div>
                </div>
                <div class="icon-btn" onclick="app.toggleTheme()">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </div>
                <div id="header-user-status" onclick="app.nav('profile', document.querySelectorAll('.nav-item')[2])" style="font-size:0.8rem; font-weight:bold; color:var(--primary); cursor:pointer;">
                    <i class="far fa-user"></i>
                </div>
            </div>
        </header>

        <section id="home" class="screen active">
            <!-- UPDATED SEARCH WITH FILTER TOGGLE -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="Ù„ÛÚ¯Û•Ø±ÛŒØ§Ù†..." oninput="app.advancedSearch()">
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div class="sort-btn" onclick="app.toggleFilterPanel()">
                    <i class="fas fa-sliders-h" style="font-size:1.1rem;"></i>
                </div>
            </div>

            <!-- NEW ADVANCED FILTER PANEL -->
            <div id="filter-panel" style="display:none;">
                <div class="filter-input-row">
                    <input type="text" id="filter-author" class="filter-input" placeholder="Ù†Ø§Ú¤Û Ù†Ú¤ÛŒØ³Û•Ø±ÛŒ / ÙˆÛ•Ø±Ú¯ÛÚ•ÛŒ" oninput="app.advancedSearch()">
                </div>
                <div class="filter-input-row">
                    <input type="number" id="filter-min-price" class="filter-input" placeholder="Ú©ÛÙ…ØªØ±ÛŒÙ† Ù†Ø±Ø®" oninput="app.advancedSearch()">
                    <input type="number" id="filter-max-price" class="filter-input" placeholder="Ø²Û†Ø±ØªØ±ÛŒÙ† Ù†Ø±Ø®" oninput="app.advancedSearch()">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.8rem; color:var(--text-light);">Ú•ÛŒØ²Ø¨Û•Ù†Ø¯ÛŒ:</span>
                    <select id="filter-sort" class="filter-select" onchange="app.advancedSearch()">
                        <option value="default">Ø¦Ø§Ø³Ø§ÛŒÛŒ</option>
                        <option value="low-high">Ù†Ø±Ø®: Ú©ÛÙ… â¡ï¸ Ø²Û†Ø±</option>
                        <option value="high-low">Ù†Ø±Ø®: Ø²Û†Ø± â¡ï¸ Ú©ÛÙ…</option>
                    </select>
                </div>
            </div>
            
            <h4 style="padding:0 20px; color:var(--text-light); font-size:0.9rem;" data-lang="libraries">Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û•</h4>
            <div class="stories-container" id="stories-list"></div>
            
            <div class="categories">
                <div class="cat-chip active" onclick="app.filter('all', this)" data-lang="all">Ù‡Û•Ù…ÛŒ</div>
                <div class="cat-chip" onclick="app.filter('discounted', this)" data-lang="discount_filter">Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† ğŸ”¥</div>
                <div class="cat-chip" onclick="app.filter('favorites', this)" data-lang="fav">Ø¯ÚµØ®ÙˆØ§Ø² â¤ï¸</div>
                <div class="cat-chip" onclick="app.filter('Ù‚ÙˆØ±Ø¦Ø§Ù†', this)" data-lang="quran">Ù‚ÙˆØ±Ø¦Ø§Ù†</div>
                <div class="cat-chip" onclick="app.filter('Ø¹Û•Ù‚ÛŒØ¯Û•', this)" data-lang="aqida">Ø¹Û•Ù‚ÛŒØ¯Û•</div>
                <div class="cat-chip" onclick="app.filter('ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•', this)" data-lang="hadith">ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•</div>
                <div class="cat-chip" onclick="app.filter('Ù…ÛÚ˜ÙˆÙˆ', this)" data-lang="history">Ù…ÛÚ˜ÙˆÙˆ</div>
                <div class="cat-chip" onclick="app.filter('city', this)" data-lang="city_filter">Ø¨Ø§Ú˜ÛÚ•</div>
            </div>
            
            <div id="city-filters" class="categories" style="display:none; margin-top:-10px;"></div>

            <div class="grid" id="book-grid"></div>
            <div class="request-box">
                <h3 style="font-size:1rem; color:var(--primary);" data-lang="req_title">Ú©ØªÛØ¨Û•Ú©Û•Øª Ù†Û•Ø¯Û†Ø²ÛŒÛ•ÙˆÛ•ØŸ</h3>
                <p style="font-size:0.8rem; color:var(--text-light); margin-bottom:10px;" data-lang="req_desc">Ù†Ø§Ú¤Û Ù¾Û•Ø±ØªÙˆÙˆÚ©Û Ø¨Ù†Ú¤ÛŒØ³Û•ØŒ Ø¦Û•Ù… Ø¯Û Ø¨Û† ØªÛ• Ø¯Ø§Ø¨ÛŒÙ† Ú©Û•ÛŒÙ†.</p>
                <div class="req-input-row">
                    <input type="text" id="req-book-input" class="req-input" placeholder="Ù†Ø§Ú¤Û Ù¾Û•Ø±ØªÙˆÙˆÚ©Û...">
                    <button class="btn-req" onclick="app.requestBook()" data-lang="send">Ù‡Ù†Ø§Ø±ØªÙ†</button>
                </div>
            </div>
            <div style="height:100px;"></div> 
        </section>

        <section id="cart" class="screen">
            <div style="padding:20px;">
                <h2 style="margin-bottom:20px; color:var(--text-main);" data-lang="cart_title">Ø³Û•Ø¨Û•ØªÛ•ÛŒØ§ Ú©Ú•ÛŒÙ†Û</h2>
                <div id="cart-list"></div>
                <div style="background:var(--bg-card); padding:20px; border-radius:20px; margin-top:20px; box-shadow:var(--shadow);">
                    
                    <div id="points-redeem-section" style="display:none;">
                        <div class="points-redeem-box">
                            <div>
                                <div style="font-size:0.8rem; opacity:0.9;">Ø®Ø§ÚµÛÙ† ØªÛ•: <span id="my-current-points">0</span></div>
                                <div style="font-weight:bold;">Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† Ø¨ Ø®Ø§ÚµØ§Ù†</div>
                            </div>
                            <select id="points-select" style="padding:5px; border-radius:10px; border:none; color:black;">
                                <option value="0">Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•</option>
                            </select>
                            <button class="redeem-btn" onclick="app.applyPointsDiscount()">Ú†Ø§Ù„Ø§Ú© Ø¨Ú©Û•</button>
                        </div>
                        <p id="points-msg" style="font-size:0.75rem; margin-top:5px; color:var(--success); text-align:center;"></p>
                    </div>

                    <div class="coupon-box">
                        <input type="text" id="coupon-input" class="coupon-input" placeholder="CODE">
                        <button class="btn-apply" onclick="app.applyCoupon()">Check</button>
                    </div>
                    <div id="coupon-msg" style="font-size:0.8rem; margin:5px 0 15px; color:var(--success); min-height:18px;"></div>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="color:var(--text-light);" data-lang="price">Ù†Ø±Ø®</span>
                        <span id="sub-total">0 IQD</span>
                    </div>
                    
                    <div class="delivery-box">
                        <div class="delivery-header">
                            <i class="fas fa-truck-moving"></i> &nbsp; Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ú¯Û•Ù‡Ø§Ù†Ø¯Ù†Û
                        </div>
                        <div class="delivery-body">
                            <div class="input-group">
                                <i class="fas fa-map-marker-alt input-group-icon"></i>
                                <select id="delivery-city-select" class="delivery-select" onchange="app.updateDeliveryFee()">
                                    <option value="">-- Ø¨Ø§Ú˜ÛÚ• / Ø¯Û•Ú¤Û•Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û• --</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-pen-alt input-group-icon"></i>
                                <input type="text" id="delivery-details" class="delivery-input" placeholder="ØªÛØ¨ÛŒÙ†ÛŒ (Ù†Ø§Ú¤Û ØªØ§Ø®ÛŒØŒ Ù†ÛØ²ÛŒÚ© Ù…Ø²Ú¯Û•ÙØªÛ...)">
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="color:var(--info);">Ú¯Û•Ù‡Ø§Ù†Ø¯Ù† (Delivery)</span>
                        <span id="delivery-fee">0 IQD</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:var(--danger);" data-lang="discount">Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†</span>
                        <span id="discount-val">0 IQD</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:1.2rem; font-weight:800; color:var(--text-main); border-top:1px dashed #ccc; padding-top:10px;">
                        <span data-lang="total">Ú©Û†ÛŒÛ Ú¯Ø´ØªÛŒ</span>
                        <span id="final-total" style="color:var(--primary);">0 IQD</span>
                    </div>
                    <button class="btn btn-primary" onclick="app.smartCheckout()">
                        <i class="fas fa-check-circle" style="font-size:1.4rem;"></i>
                        <span data-lang="checkout">ØªÛ•Ù…Ø§Ù…Ú©Ø±Ù†Ø§ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛ</span>
                    </button>
                </div>
            </div>
            <div style="height:100px;"></div>
        </section>

        <section id="profile" class="screen">
            <div id="profile-guest" class="hidden" style="text-align:center; padding:50px 20px;">
                <i class="fas fa-user-lock" style="font-size:4rem; color:var(--text-light); margin-bottom:20px;"></i>
                <h2 data-lang="guest_title">ØªÚ©Ø§ÛŒÛ• ÙˆÛ•Ø±Û• Ú˜ÙˆÙˆØ±</h2>
                <p style="color:var(--text-light); margin-bottom:30px;" data-lang="guest_desc">Ø¨Û† Ø¯ÛŒØªÙ†Ø§ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ùˆ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ø®Û†ØŒ Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¨Ú†ÛŒÛ• Ú˜ÙˆÙˆØ±.</p>
                <button class="btn btn-primary" onclick="app.toggleAuthOverlay()" data-lang="login_btn">Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ± / ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†</button>
            </div>

            <div id="profile-user" class="hidden">
                <div class="profile-header">
                    <div class="edit-fab" onclick="app.toggleEditMode()">
                        <i class="fas fa-edit" id="edit-icon"></i>
                    </div>
                    <div class="avatar-container">
                        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="avatar">
                    </div>
                    <h2 id="p-name-display">User Name</h2>
                    <p id="p-phone-display" style="opacity:0.8;">0750...</p>
                    <div class="points-badge">
                        <i class="fas fa-star"></i> <span id="p-points-display">0</span> <span data-lang="points">Ø®Ø§Ù„</span>
                    </div>
                </div>

                <div class="profile-card">
                    <h3 style="margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px; color:var(--text-main);" data-lang="personal_info">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ú©Û•Ø³ÛŒ</h3>
                    
                    <!-- Notification Button -->
                    <button class="btn btn-outline" onclick="app.enableNotifications()" style="margin-bottom:20px; font-size:0.9rem;">
                        <i class="fas fa-bell"></i> Ú†Ø§Ù„Ø§Ú©Ú©Ø±Ù†Ø§ Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒØ§Ù† ğŸ””
                    </button>

                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-user"></i> <span data-lang="name">Ù†Ø§Ú¤</span></span>
                        <span class="info-val" id="val-name">...</span>
                        <input type="text" id="inp-name" class="edit-input hidden">
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-phone"></i> <span data-lang="phone">Ù…Û†Ø¨Ø§ÛŒÙ„</span></span>
                        <span class="info-val" id="val-phone">...</span>
                        <input type="tel" id="inp-phone" class="edit-input hidden" disabled>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-city"></i> <span>Ø¨Ø§Ú˜ÛÚ•</span></span>
                        <span class="info-val" id="val-city">...</span>
                        <select id="inp-city" class="edit-input hidden"></select>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-map-marker-alt"></i> <span data-lang="address">Ù†Ø§Ú¤Ù†ÛŒØ´Ø§Ù†</span></span>
                        <span class="info-val" id="val-address">...</span>
                        <input type="text" id="inp-address" class="edit-input hidden">
                    </div>
                    <div id="save-btn-container" class="hidden" style="margin-top:20px;">
                        <button class="btn btn-primary" onclick="app.saveProfileChanges()" data-lang="save">Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ù†</button>
                    </div>
                </div>

                <button onclick="app.logout()" id="btn-logout-edit" class="btn-logout-styled hidden">
                    <span data-lang="logout">Ø¯Û•Ø±Ú©Û•Ú¤ØªÙ† Ú˜ Ù‡Û•Ú˜Ù…Ø§Ø±Û</span> <i class="fas fa-sign-out-alt"></i>
                </button>

                <div class="live-orders-container">
                    <h3 class="live-title">
                        <i class="fas fa-history"></i> <span data-lang="my_orders">Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ùˆ Ú†Ø§Ú¤Û•Ú•ÛØ¨ÙˆÙˆÙ†</span>
                    </h3>
                    <div id="live-orders-list"></div>
                </div>
                
                <div style="height:120px;"></div>
            </div>
        </section>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="app.nav('home', this)"><i class="fas fa-home"></i></div>
            <div class="nav-item" onclick="app.nav('cart', this)">
                <i class="fas fa-shopping-bag"></i>
                <div class="badge" id="cart-count">0</div>
            </div>
            <div class="nav-item" onclick="app.nav('profile', this)"><i class="fas fa-user-circle"></i></div>
        </nav>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-hero">
            <div class="modal-hero-overlay"></div>
            <img src="" id="m-img">
            <div class="modal-btn-row">
                <div class="modal-btn-icon" onclick="app.closeModal()"><i class="fas fa-times"></i></div>
                <div class="modal-btn-icon" onclick="app.shareBook()"><i class="fas fa-share-alt"></i></div>
            </div>
        </div>
        
        <div class="modal-content-container">
            <div class="m-header-info">
                <span id="m-cat" class="m-cat-tag">Cat</span>
                <span id="m-lib" class="m-lib-tag">Lib</span>
                <h1 id="m-title" class="m-title">Title</h1>
                <p id="m-author" class="m-author">Author</p>
            </div>

            <div class="m-spec-box">
                <div class="m-spec-item" id="row-pages">
                    <i class="fas fa-file-alt m-spec-icon"></i>
                    <span class="m-spec-label" data-lang="pages">Ù„Ø§Ù¾Û•Ú•</span>
                    <span class="m-spec-val" id="m-pages">0</span>
                </div>
                <div class="m-spec-item" id="row-tahqiq">
                    <i class="fas fa-check-double m-spec-icon"></i>
                    <span class="m-spec-label" data-lang="investigation">ØªÛ•Ø­Ù‚ÛŒÙ‚</span>
                    <span class="m-spec-val" id="m-tahqiq">-</span>
                </div>
                <div class="m-spec-item" id="row-paper">
                    <i class="fas fa-copy m-spec-icon"></i>
                    <span class="m-spec-label" data-lang="paper">Ø¬ÙˆØ±Û Ú©Ø§ØºÛ•Ø²Û</span>
                    <span class="m-spec-val" id="m-paper">-</span>
                </div>
                <div class="m-spec-item" id="row-volumes">
                    <i class="fas fa-book m-spec-icon"></i>
                    <span class="m-spec-label" data-lang="volumes">Ú˜Ù…Ø§Ø±Ø§ Ø¨Û•Ø±Ú¯Ø§Ù†</span>
                    <span class="m-spec-val" id="m-volumes">1</span>
                </div>
            </div>

            <div class="m-offers">
                <div class="m-offer-row" id="m-delivery-row">
                    <i class="fas fa-truck"></i> 
                    <span id="m-delivery-text">Ú¯Û•Ù‡Ø§Ù†Ø¯Ù† Ø¨Û Ø¨Û•Ø±Ø§Ù…Ø¨Û•Ø±Û• Ø¨Û† Ú©Ú•ÛŒÙ†Ø§ Ø³Û•Ø±ÙˆÙˆÛŒ <span id="m-free-limit">50,000</span> IQD</span>
                </div>
                <div class="m-offer-row" id="m-wholesale-row"><i class="fas fa-tags"></i> <span>Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† Ù‡Û•ÛŒÛ• Ø¨Û† Ú©Ú•ÛŒÙ†Ø§ <span id="m-bulk-qty" style="font-weight:bold;">5</span>+ Ø¯Ø§Ù†Û•</span></div>
            </div>

            <h4 style="margin-bottom:10px; color:var(--text-main);" data-lang="summary">Ù¾ÙˆØ®ØªÛ•</h4>
            <div id="m-desc" class="m-desc-box">...</div>
            
            <button class="btn btn-outline" onclick="app.openPreview()">
                <i class="fas fa-book-reader"></i> <span data-lang="preview">Ú†Ø§Ú¤Ø®Ø´Ø§Ù†Ø¯Ù† (Ù†Ù…ÙˆÙˆÙ†Û•)</span>
            </button>

            <div class="related-books-section">
                <div class="related-title" data-lang="related">Ù¾Û•Ø±ØªÙˆÙˆÚ©ÛÙ† Ù‡Û•Ú¤Ø´ÛÙˆÛ•</div>
                <div class="related-scroll" id="related-books-container"></div>
            </div>
        </div>

        <div class="modal-footer">
            <div style="flex:1;">
                <div style="font-size:0.8rem; color:var(--text-light);" data-lang="price">Ù†Ø±Ø®</div>
                <div id="m-price" style="font-size:1.4rem; font-weight:900; color:var(--primary);">0 IQD</div>
            </div>
            <button class="btn btn-primary" style="flex:1.5;" onclick="app.addToCartFromModal()">
                <span data-lang="add_to_cart">Ø²ÛŒØ§Ø¯Ú©Ø±Ù†</span> <i class="fas fa-cart-plus"></i>
            </button>
        </div>
    </div>

    <script>
        // NOTE: For Background Notifications to work, you MUST create 'firebase-messaging-sw.js'
        // in the root directory. Inside this HTML file, we only handle Foreground notifications.
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Registered', reg)).catch(err => console.log('SW Error', err));
        }

        const firebaseConfig = {
            apiKey: "AIzaSyB8-7RLi1UbixK8d-LGmH-K-SfR-GaMZ2E",
            authDomain: "projeislambook.firebaseapp.com",
            projectId: "projeislambook",
            storageBucket: "projeislambook.firebasestorage.app",
            messagingSenderId: "577300732966",
            appId: "1:577300732966:web:df3000e0db45adf4e51ae7",
            measurementId: "G-SJ97S3FWYE"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const firestore = firebase.firestore();
        let messaging;
        try {
            messaging = firebase.messaging();
        } catch(e) {
            console.log("Messaging not supported or blocked");
        }

        const DEFAULT_IMG = "https://via.placeholder.com/300x450/cccccc/000000?text=No+Image";

        const translations = {
            'badini': {
                app_name: "Ù¾Ú•Û†Ú˜Û Ø¦ÛŒØ³Ù„Ø§Ù…", search_place: "Ù„ÛÚ¯Û•Ø±ÛŒØ§Ù†...", all: "Ù‡Û•Ù…ÛŒ", fav: "Ø¯ÚµØ®ÙˆØ§Ø² â¤ï¸", quran: "Ù‚ÙˆØ±Ø¦Ø§Ù†", aqida: "Ø¹Û•Ù‚ÛŒØ¯Û•", hadith: "ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•", history: "Ù…ÛÚ˜ÙˆÙˆ", city_filter: "Ø¨Ø§Ú˜ÛÚ•",
                cart_title: "Ø³Û•Ø¨Û•ØªÛ•", price: "Ù†Ø±Ø®", discount: "Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†", total: "Ú©Û†ÛŒÛ Ú¯Ø´ØªÛŒ", checkout: "ØªÛ•Ù…Ø§Ù…Ú©Ø±Ù†Ø§ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛ",
                guest_title: "ØªÚ©Ø§ÛŒÛ• ÙˆÛ•Ø±Û• Ú˜ÙˆÙˆØ±", guest_desc: "Ø¨Û† Ø¯ÛŒØªÙ†Ø§ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ùˆ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ø®Û†ØŒ Ù¾ÛØ¯Ú¤ÛŒÛ• Ø¨Ú†ÛŒÛ• Ú˜ÙˆÙˆØ±.",
                login_btn: "Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ± / ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†", login: "Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±", create: "Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ù†", no_account: "ØªÛ• Ù‡Û•Ú˜Ù…Ø§Ø± Ù†ÛŒÙ†Û•ØŸ", new_account: "Ù‡Û•Ú˜Ù…Ø§Ø±Ø§ Ù†ÙˆÛ", register_btn: "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ù†", have_account: "ØªÛ• Ù‡Û•Ú˜Ù…Ø§Ø± Ù‡Û•ÛŒÛ•ØŸ",
                personal_info: "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛÙ† Ú©Û•Ø³ÛŒ", name: "Ù†Ø§Ú¤", phone: "Ù…Û†Ø¨Ø§ÛŒÙ„", address: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†", save: "Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ù†",
                my_orders: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ùˆ Ù…ÛÚ˜ÙˆÙˆ", logout: "Ø¯Û•Ø±Ú©Û•Ú¤ØªÙ† Ú˜ Ù‡Û•Ú˜Ù…Ø§Ø±Û",
                pages: "Ù„Ø§Ù¾Û•Ú•", investigation: "ØªÛ•Ø­Ù‚ÛŒÙ‚", paper: "Ø¬ÙˆØ±Û Ú©Ø§ØºÛ•Ø²Û", volumes: "Ú˜Ù…Ø§Ø±Ø§ Ø¨Û•Ø±Ú¯Ø§Ù†", summary: "Ù¾ÙˆØ®ØªÛ•", preview: "Ú†Ø§Ú¤Ø®Ø´Ø§Ù†Ø¯Ù†", add_to_cart: "Ø²ÛŒØ§Ø¯Ú©Ø±Ù†", view: "Ø¨Ø¨ÛŒÙ†Û•", related: "Ù¾Û•Ø±ØªÙˆÙˆÚ©ÛÙ† Ù‡Û•Ú¤Ø´ÛÙˆÛ•", points: "Ø®Ø§Úµ",
                wait: "Ú†Ø§Ú¤Û•Ú•ÛÚ©Ø±Ù†", approved: "ÙˆÛ•Ø±Ú¯Ø±ØªÙ† (Ø¦Û•Ø¯Ù…ÛŒÙ†)", delivered: "Ú¯Û•Ù‡Ø´Øª (ØªÛ•Ù…Ø§Ù…)", canceled: "Ù‡Ø§ØªÛ• Ù‡Û•Ù„ÙˆÛ•Ø´Ø§Ù†Ø¯Ù†", empty_cart: "Ø³Û•Ø¨Û•ØªÛ• ÛŒØ§ Ø¨Û•ØªØ§ÚµÛ•", sent_msg: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ù‡Ø§ØªÛ• Ù‡Ù†Ø§Ø±ØªÙ† âœ…",
                lang_val: "Ú©ÙˆØ±Ø¯ÛŒ", req_title: "Ú©ØªÛØ¨Û•Ú©Û•Øª Ù†Û•Ø¯Û†Ø²ÛŒÛ•ÙˆÛ•ØŸ", req_desc: "Ù†Ø§Ú¤Û Ù¾Û•Ø±ØªÙˆÙˆÚ©Û Ø¨Ù†Ú¤ÛŒØ³Û•ØŒ Ø¦Û•Ù… Ø¯Û Ø¨Û† ØªÛ• Ø¯Ø§Ø¨ÛŒÙ† Ú©Û•ÛŒÙ†.", send: "Ù‡Ù†Ø§Ø±ØªÙ†",
                req_sent: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒØ§ Ù¾Û•Ø±ØªÙˆÙˆÚ©Û Ú¯Û•Ù‡Ø´Øª ğŸ“¥", 
                confirm_btn: "ÙˆÛ•Ø±Ú¯Ø±ØªÙ† (Ù¾Ø´ØªÚ•Ø§Ø³ØªÚ©Ø±Ù†)", enter_code: "Ú©Û†Ø¯ÛŒ Ø¨Ù†Ú¤ÛŒØ³Û•", code_desc: "Ú©Û†Ø¯Û Ø¯ Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒØ§Ù† Ø¯Ø§ Ø¨Û† ØªÛ• Ù‡Ø§ØªÛŒ Ø¨Ù†Ú¤ÛŒØ³Û•.",
                wrong_code: "Ú©Û†Ø¯ Ø´Ø§Ø´Û•! âŒ", code_success: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ú¯Û•Ù‡Ø´Øª! Ø³ÙˆÙ¾Ø§Ø³ ğŸ’™", libraries: "Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û•", discount_filter: "Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† ğŸ”¥"
            },
            'sorani': {
                app_name: "Ù¾Ú•Û†Ú˜Û•ÛŒ Ø¦ÛŒØ³Ù„Ø§Ù…", search_place: "Ú¯Û•Ú•Ø§Ù†...", all: "Ù‡Û•Ù…ÙˆÙˆ", fav: "Ø¯ÚµØ®ÙˆØ§Ø² â¤ï¸", quran: "Ù‚ÙˆØ±Ø¦Ø§Ù†", aqida: "Ø¹Û•Ù‚ÛŒØ¯Û•", hadith: "ÙÛ•Ø±Ù…ÙˆÙˆØ¯Û•", history: "Ù…ÛÚ˜ÙˆÙˆ", city_filter: "Ø´Ø§Ø±",
                cart_title: "Ø³Û•Ø¨Û•ØªÛ•", price: "Ù†Ø±Ø®", discount: "Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†", total: "Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ", checkout: "ØªÛ•ÙˆØ§ÙˆÚ©Ø±Ø¯Ù†ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ",
                guest_title: "ØªÚ©Ø§ÛŒÛ• ÙˆÛ•Ø±Û• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•", guest_desc: "Ø¨Û† Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ùˆ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ØªØŒ Ù¾ÛÙˆÛŒØ³ØªÛ• Ø¨Ú†ÛŒØªÛ• Ú˜ÙˆÙˆØ±Û•ÙˆÛ•.",
                login_btn: "Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ± / ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†", login: "Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±", create: "Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†", no_account: "Ù‡Û•Ú˜Ù…Ø§Ø±Øª Ù†ÛŒÛŒÛ•ØŸ", new_account: "Ù‡Û•Ú˜Ù…Ø§Ø±ÛŒ Ù†ÙˆÛ", register_btn: "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†", have_account: "Ù‡Û•Ú˜Ù…Ø§Ø±Øª Ù‡Û•ÛŒÛ•ØŸ",
                personal_info: "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ú©Û•Ø³ÛŒ", name: "Ù†Ø§Ùˆ", phone: "Ù…Û†Ø¨Ø§ÛŒÙ„", address: "Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†", save: "Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÚ©Ø±Ø¯Ù†",
                my_orders: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ùˆ Ù…ÛÚ˜ÙˆÙˆ", logout: "Ø¯Û•Ø±Ú†ÙˆÙˆÙ†",
                pages: "Ù„Ø§Ù¾Û•Ú•Û•", investigation: "ØªÛ•Ø­Ù‚ÛŒÙ‚", paper: "Ø¬Û†Ø±ÛŒ Ú©Ø§ØºÛ•Ø²", volumes: "Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¨Û•Ø±Ú¯", summary: "Ù¾ÙˆØ®ØªÛ•", preview: "Ù¾ÛØ¯Ø§Ú†ÙˆÙˆÙ†Û•ÙˆÛ•", add_to_cart: "Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†", view: "Ø¨ÛŒÙ†ÛŒÙ†", related: "Ù¾Û•Ø±ØªÙˆÙˆÚ©Û• Ù‡Ø§ÙˆØ´ÛÙˆÛ•Ú©Ø§Ù†", points: "Ø®Ø§Úµ",
                wait: "Ú†Ø§Û•Ú•ÛÚ©Ø±Ø¯Ù†", approved: "ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§ (Ø¦Û•Ø¯Ù…ÛŒÙ†)", delivered: "Ú¯Û•ÛŒØ´Øª (ØªÛ•ÙˆØ§Ùˆ)", canceled: "Ù‡Û•ÚµÙˆÛ•Ø´ÛÙ†Ø±Ø§ÛŒÛ•ÙˆÛ•", empty_cart: "Ø³Û•Ø¨Û•ØªÛ• Ø¨Û•ØªØ§ÚµÛ•", sent_msg: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ù†ÛØ±Ø¯Ø±Ø§ âœ…",
                lang_val: "Ú©ÙˆØ±Ø¯ÛŒ", req_title: "Ú©ØªÛØ¨Û•Ú©Û•Øª Ù†Û•Ø¯Û†Ø²ÛŒÛ•ÙˆÛ•ØŸ", req_desc: "Ù†Ø§ÙˆÛŒ Ú©ØªÛØ¨Û•Ú©Û• Ø¨Ù†ÙˆÙˆØ³Û•ØŒ Ø¨Û†ØªÛŒ Ø¯Ø§Ø¨ÛŒÙ† Ø¯Û•Ú©Û•ÛŒÙ†.", send: "Ù†Ø§Ø±Ø¯Ù†",
                req_sent: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ú©ØªÛØ¨ Ú¯Û•ÛŒØ´Øª ğŸ“¥",
                confirm_btn: "ÙˆÛ•Ø±Ú¯Ø±ØªÙ† (Ù¾Ø´ØªÚ•Ø§Ø³ØªÚ©Ø±Ø¯Ù†)", enter_code: "Ú©Û†Ø¯ Ø¨Ù†ÙˆÙˆØ³Û•", code_desc: "Ø¦Û•Ùˆ Ú©Û†Ø¯Û•ÛŒ Ù„Û• Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±Ú©Ø±Ø¯Ù†Û•ÙˆÛ• Ù‡Ø§ØªÙˆÙˆ Ø¨Ù†ÙˆÙˆØ³Û•.",
                wrong_code: "Ú©Û†Ø¯ Ù‡Û•ÚµÛ•ÛŒÛ•! âŒ", code_success: "Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ú¯Û•ÛŒØ´Øª! Ø³ÙˆÙ¾Ø§Ø³ ğŸ’™", libraries: "Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†Û•", discount_filter: "Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† ğŸ”¥"
            },
            'arabic': {
                app_name: "Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…", search_place: "Ø¨Ø­Ø«...", all: "Ø§Ù„ÙƒÙ„", fav: "Ø§Ù„Ù…ÙØ¶Ù„Ø© â¤ï¸", quran: "Ù‚Ø±Ø¢Ù†", aqida: "Ø¹Ù‚ÙŠØ¯Ø©", hadith: "Ø­Ø¯ÙŠØ«", history: "ØªØ§Ø±ÙŠØ®", city_filter: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©",
                cart_title: "Ø§Ù„Ø³Ù„Ø©", price: "Ø§Ù„Ø³Ø¹Ø±", discount: "Ø§Ù„Ø®ØµÙ…", total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ", checkout: "Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨",
                guest_title: "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", guest_desc: "Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø·Ù„Ø¨Ø§ØªÙƒ ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒØŒ ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
                login_btn: "Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„", login: "Ø¯Ø®ÙˆÙ„", create: "Ø¥Ù†Ø´Ø§Ø¡", no_account: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ", new_account: "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", register_btn: "ØªØ³Ø¬ÙŠÙ„", have_account: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ",
                personal_info: "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©", name: "Ø§Ù„Ø§Ø³Ù…", phone: "Ø§Ù„Ù‡Ø§ØªÙ", address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", save: "Ø­ÙØ¸",
                my_orders: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø³Ø¬Ù„", logout: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
                pages: "ØµÙØ­Ø§Øª", investigation: "Ø§Ù„ØªØ­Ù‚ÙŠÙ‚", paper: "Ù†ÙˆØ¹ Ø§Ù„ÙˆØ±Ù‚", volumes: "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª", summary: "Ù…Ù„Ø®Øµ", preview: "Ù…Ø¹Ø§ÙŠÙ†Ø©", add_to_cart: "Ø¥Ø¶Ø§ÙØ©", view: "Ø¹Ø±Ø¶", related: "ÙƒØªØ¨ Ù…Ø´Ø§Ø¨Ù‡Ø©", points: "Ù†Ù‚Ø·Ø©",
                wait: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", approved: "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„", delivered: "ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„", canceled: "Ù…Ù„ØºÙŠ", empty_cart: "Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©", sent_msg: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…",
                lang_val: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", req_title: "Ù„Ù… ØªØ¬Ø¯ ÙƒØªØ§Ø¨ÙƒØŸ", req_desc: "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙƒØªØ§Ø¨ ÙˆØ³Ù†ÙˆÙØ±Ù‡ Ù„Ùƒ.", send: "Ø¥Ø±Ø³Ø§Ù„",
                req_sent: "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„ÙƒØªØ§Ø¨ ğŸ“¥",
                confirm_btn: "Ø§Ø³ØªÙ„Ø§Ù… (ØªØ£ÙƒÙŠØ¯)", enter_code: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²", code_desc: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Ùƒ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.",
                wrong_code: "Ø§Ù„Ø±Ù…Ø² Ø®Ø§Ø·Ø¦! âŒ", code_success: "ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨! Ø´ÙƒØ±Ø§Ù‹ ğŸ’™", libraries: "Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª", discount_filter: "Ø®ØµÙˆÙ…Ø§Øª ğŸ”¥"
            }
        };

        const app = {
            state: {
                user: JSON.parse(localStorage.getItem('user_pro_max')) || null,
                cart: JSON.parse(localStorage.getItem('cart_pro_max')) || [],
                favs: JSON.parse(localStorage.getItem('favs_pro_max')) || [],
                orders: [],
                notifications: JSON.parse(localStorage.getItem('notifs_pro_max')) || [],
                darkMode: localStorage.getItem('theme_pro_max') === 'dark',
                lang: localStorage.getItem('lang_pro_max') || 'arabic', 
                currentBook: null,
                isEditMode: false,
                sortAsc: true,
                discount: 0,
                pointsDiscount: 0,
                verifyOrderId: null,
                ordersListener: null,
                pointsListener: null,
                activeLibFilter: null,
                deliveryFee: 0,
                isSubmitting: false, 
                books: [],
                libraries: [],
                cities: [],
                pointRules: [],
                dataLoaded: false,
                isInitialNotifLoad: true 
            },

            init() {
                if (this.state.darkMode) document.body.setAttribute('data-theme', 'dark');
                this.updateTexts();
                this.checkOnlineStatus();
                this.fetchAllData();
                this.updateCartUI();
                this.checkHeaderStatus();
                this.checkNotifications();
                if(this.state.user) {
                    this.fetchLiveOrders();
                }
                this.setupInputListeners();
            },

            checkOnlineStatus() {
                const handleStatus = () => {
                    const overlay = document.getElementById('offline-overlay');
                    if (navigator.onLine) {
                        overlay.style.display = 'none';
                    } else {
                        overlay.style.display = 'flex';
                    }
                };
                window.addEventListener('online', handleStatus);
                window.addEventListener('offline', handleStatus);
                handleStatus(); 
            },

            fetchAllData() {
                document.getElementById('loader-overlay').style.opacity = '1';
                document.getElementById('loader-overlay').style.display = 'flex';

                let loadedCount = 0;
                const checkDone = () => {
                    loadedCount++;
                    if(loadedCount >= 4) {
                        this.state.dataLoaded = true;
                        document.getElementById('loader-overlay').style.opacity = '0';
                        setTimeout(() => { document.getElementById('loader-overlay').style.display = 'none'; }, 500);
                        setTimeout(() => { this.state.isInitialNotifLoad = false; }, 2000);
                    }
                };

                firestore.collection('books').onSnapshot(snap => {
                    this.state.books = [];
                    snap.forEach(doc => { this.state.books.push({ docId: doc.id, ...doc.data() }); });
                    this.renderBooks(this.state.books);
                    checkDone();
                });

                firestore.collection('libraries').onSnapshot(snap => {
                    this.state.libraries = [];
                    snap.forEach(doc => { this.state.libraries.push({ docId: doc.id, ...doc.data() }); });
                    this.renderLibraries();
                    checkDone();
                });

                firestore.collection('settings').doc('locations').onSnapshot(doc => {
                    if(doc.exists) {
                        this.state.cities = doc.data().list || [];
                        this.renderCityOptions();
                        this.renderCityFilters();
                        this.renderDeliveryOptions();
                    }
                    checkDone();
                });

                firestore.collection('settings').doc('points_rules_dynamic').onSnapshot(doc => {
                    if(doc.exists) {
                        this.state.pointRules = doc.data().rules || [];
                        this.renderPointRedeemOptions();
                    }
                    checkDone();
                });

                firestore.collection('notifications').orderBy('id', 'desc').limit(5).onSnapshot(snap => {
                    snap.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            if (!this.state.user) return;
                            
                            if (!data.targetPhone || data.targetPhone === this.state.user.phone) {
                                this.addNotification(data.text, data.id);
                                if (!this.state.isInitialNotifLoad) {
                                    const lastSeenTime = parseInt(localStorage.getItem('last_seen_toast_time')) || 0;
                                    if (data.id > lastSeenTime) {
                                        this.showToast("ğŸ”” " + data.text);
                                        localStorage.setItem('last_seen_toast_time', data.id);
                                    }
                                }
                            }
                        }
                    });
                });
            },

            // --- ADVANCED SEARCH & FILTER ---
            toggleFilterPanel() {
                const panel = document.getElementById('filter-panel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            },

            advancedSearch() {
                const query = document.getElementById('search-input').value.toLowerCase().trim();
                const authorQuery = document.getElementById('filter-author').value.toLowerCase().trim();
                const minPrice = parseFloat(document.getElementById('filter-min-price').value) || 0;
                const maxPrice = parseFloat(document.getElementById('filter-max-price').value) || Infinity;
                const sortType = document.getElementById('filter-sort').value;
                
                let filtered = this.state.books.filter(b => {
                    const matchTitle = b.title.toLowerCase().includes(query) || (b.desc && b.desc.toLowerCase().includes(query));
                    const matchAuthor = !authorQuery || (b.author && b.author.toLowerCase().includes(authorQuery)) || (b.translator && b.translator.toLowerCase().includes(authorQuery));
                    const matchPrice = b.price >= minPrice && b.price <= maxPrice;
                    return matchTitle && matchAuthor && matchPrice;
                });

                if(sortType === 'low-high') {
                    filtered.sort((a, b) => a.price - b.price);
                } else if(sortType === 'high-low') {
                    filtered.sort((a, b) => b.price - a.price);
                }

                this.renderBooks(filtered);
            },

            // --- PUSH NOTIFICATIONS ---
            async enableNotifications() {
                if(!messaging) return this.showToast("Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒ Ù„ Ø³Û•Ø± Ú¤ÛŒ Ø¦Ø§Ù…ÛØ±ÛŒ Ù†ÛŒÙ†Û•");
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        // REPLACE 'YOUR_PUBLIC_KEY' with your actual key from Firebase Console
                        const token = await messaging.getToken({ vapidKey: 'BMD_dJqS32u...' }); 
                        if (token) {
                            console.log('FCM Token:', token);
                            if(this.state.user) {
                                await firestore.collection('users').doc(this.state.user.phone).update({
                                    fcmToken: token
                                });
                                this.showToast("Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒ Ú†Ø§Ù„Ø§Ú© Ø¨ÙˆÙˆÙ† âœ…");
                            }
                        } else {
                            this.showToast("Ù†Ø§ØªÙˆØ§Ù†Ø±ÛØª ØªÛ†Ú©Ù† ÙˆÛ•Ø±Ø¨Ú¯ÛŒØ±ÛØª âŒ");
                        }
                    } else {
                        this.showToast("Ù…Û†ÚµÛ•ØªÛŒ Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒ Ø±Û•ØªÚ©Ø±Ø§ÛŒÛ•ÙˆÛ• âš ï¸");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    this.showToast("Ù‡Û•ÚµÛ• Ù‡Û•ÛŒÛ•: VapidKey");
                }
            },

            renderCityOptions() {
                const options = this.state.cities.map(c => `<option value="${c}">${c}</option>`).join('');
                if(document.getElementById('reg-city')) document.getElementById('reg-city').innerHTML = options;
                if(document.getElementById('inp-city')) {
                    document.getElementById('inp-city').innerHTML = options;
                    if(this.state.user && this.state.user.city) document.getElementById('inp-city').value = this.state.user.city;
                }
            },
            
            renderDeliveryOptions() {
                const select = document.getElementById('delivery-city-select');
                if(!select) return;
                const options = `<option value="">-- Ø¨Ø§Ú˜ÛÚ• / Ø¯Û•Ú¤Û•Ø± Ù‡Û•ÚµØ¨Ú˜ÛØ±Û• --</option>` + 
                                this.state.cities.map(c => `<option value="${c}">${c}</option>`).join('');
                select.innerHTML = options;
            },

            renderCityFilters() {
                const container = document.getElementById('city-filters');
                container.innerHTML = this.state.cities.map(c => 
                    `<div class="cat-chip" onclick="app.filterCity('${c}')">${c}</div>`
                ).join('');
            },

            renderPointRedeemOptions() {
                const select = document.getElementById('points-select');
                let html = `<option value="0">Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•</option>`;
                this.state.pointRules.forEach(rule => {
                    html += `<option value="${rule.points}">${rule.points} Ø®Ø§Úµ (-${rule.discount * 100}%)</option>`;
                });
                select.innerHTML = html;
            },

            setupInputListeners() {
                const phoneInputs = ['login-phone', 'reg-phone', 'verify-input', 'inp-phone'];
                phoneInputs.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.addEventListener('input', function(e) {
                            this.value = this.value.replace(/[^0-9]/g, '');
                        });
                    }
                });
            },

            checkHeaderStatus() {
                const icon = document.getElementById('header-user-status');
                if(this.state.user) {
                    icon.innerHTML = `<i class="fas fa-user-check"></i>`;
                    document.getElementById('profile-guest').classList.add('hidden');
                    document.getElementById('profile-user').classList.remove('hidden');
                    document.getElementById('points-redeem-section').style.display = 'block';
                    this.updateProfileUI(); this.renderOrderHistory();

                    if(!this.state.pointsListener) {
                        this.state.pointsListener = firestore.collection('users').doc(this.state.user.phone)
                            .onSnapshot(doc => {
                                if(doc.exists) {
                                    const newData = doc.data();
                                    this.state.user.points = newData.points || 0;
                                    this.state.user.name = newData.name;
                                    this.state.user.city = newData.city;
                                    this.saveUserLocally();
                                    this.updateProfileUI(); 
                                    this.updateCartUI(); 
                                }
                            });
                    }

                } else {
                    icon.innerHTML = `<i class="far fa-user"></i>`;
                    document.getElementById('profile-guest').classList.remove('hidden');
                    document.getElementById('profile-user').classList.add('hidden');
                    document.getElementById('points-redeem-section').style.display = 'none';
                    if(this.state.pointsListener) {
                        this.state.pointsListener(); 
                        this.state.pointsListener = null;
                    }
                }
            },

            fetchLiveOrders() {
                if (!this.state.user) return;
                if (this.state.ordersListener) this.state.ordersListener();
                const userPhone = String(this.state.user.phone).trim();
                this.state.ordersListener = firestore.collection('orders')
                    .where('userId', '==', userPhone) 
                    .onSnapshot((snapshot) => {
                        this.state.orders = [];
                        snapshot.forEach((doc) => {
                            this.state.orders.push({ docId: doc.id, ...doc.data() });
                        });
                        this.state.orders.sort((a, b) => b.id - a.id);
                        this.renderOrderHistory(); 
                    });
            },

            renderOrderHistory() {
                const list = document.getElementById('live-orders-list');
                if (!list) return;
                const t = translations[this.state.lang];
                if(!this.state.user || this.state.orders.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding:30px; opacity:0.6;"><i class="fas fa-box-open" style="font-size:3rem; margin-bottom:10px;"></i><p>Ù‡ÛŒÚ† Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú© Ù†ÛŒÙ†Û•</p></div>`;
                    return;
                }
                list.innerHTML = this.state.orders.map(o => {
                    let statusBadge = '', actionArea = '', cancelButton = '';
                    
                    if(o.status === 'waiting') {
                        statusBadge = `<div class="track-status-badge st-wait"><i class="fas fa-clock"></i> ${t['wait']}</div>`;
                        cancelButton = `<div class="btn-cancel-order" onclick="app.cancelOrder('${o.docId}')"><i class="fas fa-times"></i></div>`;
                    } else if(o.status === 'approved') {
                        statusBadge = `<div class="track-status-badge st-done"><i class="fas fa-check-circle"></i> ${t['approved']}</div>`;
                        actionArea = `<button class="btn-confirm-order" onclick="app.openVerifyModal(${o.id})">${t['confirm_btn']}</button>`;
                    } else if(o.status === 'delivered') {
                        statusBadge = `<div class="track-status-badge st-del"><i class="fas fa-truck"></i> ${t['delivered']}</div>`;
                    } else if(o.status === 'canceled') {
                        statusBadge = `<div class="track-status-badge st-cancel"><i class="fas fa-ban"></i> ${t['canceled']}</div>`;
                    }

                    const itemsText = o.items.map(i => `â€¢ ${i.title} <span style="font-size:0.8em; color:#888;">(x${i.qty})</span>`).join('<br>');
                    return `
                    <div class="track-card">
                        <div class="track-header">
                            <span class="track-id">#${o.id.toString().slice(-6)}</span>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <div style="text-align:left;"><div class="track-date">${o.date}</div><div style="font-size:0.7rem; color:#aaa;">${o.time}</div></div>
                                ${cancelButton}
                            </div>
                        </div>
                        ${statusBadge}
                        <div class="track-items">${itemsText}</div>
                        <div class="track-footer"><span>${t['total']}</span><span class="track-total">${o.total.toLocaleString()} IQD</span></div>
                        ${actionArea ? '<div style="margin-top:15px;">'+actionArea+'</div>' : ''}
                    </div>
                `}).join('');
            },

            async cancelOrder(docId) {
                if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„ Ù‡Û•Ù„ÙˆÛ•Ø´Ø§Ù†Ø¯Ù†Ø§ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛØŸ")) {
                    try {
                        await firestore.collection('orders').doc(docId).update({
                            status: 'canceled'
                        });
                        this.showToast("Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ù‡Ø§ØªÛ• Ù‡Û•Ù„ÙˆÛ•Ø´Ø§Ù†Ø¯Ù† ğŸ—‘ï¸");
                    } catch (err) { this.showToast("Ù‡Û•ÚµÛ• Ù„ Ù‡Û•Ù„ÙˆÛ•Ø´Ø§Ù†Ø¯Ù†Û! âŒ"); }
                }
            },

            addNotification(text, id) {
                const notifId = id || Date.now();
                const exists = this.state.notifications.find(n => n.id === notifId);
                if(exists) return;

                const notif = { id: notifId, text: text, read: false, time: new Date().toLocaleTimeString() };
                this.state.notifications.unshift(notif);
                this.saveNotifications();
                this.checkNotifications();
            },

            saveNotifications() { localStorage.setItem('notifs_pro_max', JSON.stringify(this.state.notifications)); },
            checkNotifications() {
                const unread = this.state.notifications.filter(n => !n.read).length;
                const dot = document.getElementById('notif-dot');
                if (unread > 0) dot.classList.add('show'); else dot.classList.remove('show');
                this.renderNotifications();
            },
            toggleNotif() {
                const dropdown = document.getElementById('notif-dropdown');
                dropdown.classList.toggle('show');
                
                if (dropdown.classList.contains('show')) {
                    this.state.notifications.forEach(n => n.read = true);
                    this.saveNotifications();
                    document.getElementById('notif-dot').classList.remove('show');
                }
            },
            renderNotifications() {
                const list = document.getElementById('notif-dropdown');
                if (this.state.notifications.length === 0) { list.innerHTML = `<div style="text-align:center; color:var(--text-light); padding:10px;">Ù‡ÛŒÚ† Ø¦Ø§Ú¯Û•Ù‡Ø¯Ø§Ø±ÛŒÛŒÛ•Ú© Ù†ÛŒÙ†Û•</div>`; } 
                else {
                    list.innerHTML = this.state.notifications.map(n => `<div class="notif-item"><i class="fas fa-info-circle"></i><div><div>${n.text}</div><div style="font-size:0.7rem; color:var(--text-light);">${n.time}</div></div></div>`).join('');
                }
            },

            requestBook() {
                const val = document.getElementById('req-book-input').value.trim();
                const t = translations[this.state.lang];
                if(!val) return this.showToast("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ú¤Û Ù¾Û•Ø±ØªÙˆÙˆÚ©Û Ø¨Ù†Ú¤ÛŒØ³Û• âš ï¸");
                
                firestore.collection('requests').add({
                    bookName: val,
                    user: this.state.user ? this.state.user.phone : 'Guest',
                    date: new Date().toISOString()
                });
                this.showToast(t['sent_msg']);
                document.getElementById('req-book-input').value = "";
            },

            toggleLangMenu() { document.getElementById('lang-menu').classList.toggle('show'); },
            setLang(langCode) {
                this.state.lang = langCode;
                localStorage.setItem('lang_pro_max', langCode);
                this.updateTexts();
                document.getElementById('lang-menu').classList.remove('show');
                this.updateCartUI(); 
                this.renderOrderHistory(); 
                this.updateProfileUI();
            },
            updateTexts() {
                const t = translations[this.state.lang];
                document.querySelectorAll('[data-lang]').forEach(el => { const key = el.getAttribute('data-lang'); if (t[key]) el.innerText = t[key]; });
                document.getElementById('search-input').placeholder = t['search_place'];
                document.getElementById('req-book-input').placeholder = t['req_desc'].split('ØŒ')[0] + "...";
            },

            toggleAuthOverlay() { document.getElementById('auth-overlay').classList.toggle('hidden'); },
            switchAuth(type) {
                if(type === 'register') { document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); } 
                else { document.getElementById('login-form').classList.remove('hidden'); document.getElementById('register-form').classList.add('hidden'); }
            },
            validatePhone(phone) { const cleaned = phone.replace(/\D/g, ''); return /^07\d{9}$/.test(cleaned); },

            async register() {
                const name = document.getElementById('reg-name').value.trim();
                const phone = document.getElementById('reg-phone').value.trim();
                const pass = document.getElementById('reg-pass').value.trim();
                const address = document.getElementById('reg-address').value.trim();
                const city = document.getElementById('reg-city').value;
                const age = document.getElementById('reg-age').value.trim();
                const gender = document.querySelector('input[name="gender"]:checked').value;

                if (!name || !phone || !address || !age || !pass) return this.showToast("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÛŒ Ø®Ø§Ù†Ø§Ù† Ù¾Ú• Ø¨Ú©Û• âš ï¸");
                if (!this.validatePhone(phone)) return this.showToast("Ú˜Ù…Ø§Ø±Ø§ Ù…Û†Ø¨Ø§ÛŒÙ„Û Ø¯Ú¤ÛØª 11 Ú˜Ù…Ø§Ø±Û• Ø¨ÛŒØª (07...) âš ï¸");
                
                try {
                    await firestore.collection('users').doc(phone).set({
                        name, phone, password: pass, address, city, age, gender, points: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    this.state.user = { name, phone, address, city, age, gender, points: 0 };
                    this.saveUserLocally(); this.toggleAuthOverlay(); this.showToast("Ø¨Û•Ø®ÛØ±Ù‡Ø§ØªÛŒ! Ù‡Û•Ú˜Ù…Ø§Ø± Ø¯Ø±ÙˆØ³Øª Ø¨ÙˆÙˆ âœ…");
                    this.checkHeaderStatus(); this.fetchLiveOrders();
                } catch (error) { this.showToast("Ú©ÛØ´Û•ÛŒÛ•Ú© Ù‡Û•ÛŒÛ•! Ø¯ÙˆÙˆØ¨Ø§Ø±Û• Ù‡Û•ÙˆÚµØ¨Ø¯Û• âŒ"); }
            },

            async login() {
                const phone = document.getElementById('login-phone').value.trim();
                const pass = document.getElementById('login-pass').value.trim();
                if (!phone || !pass) return this.showToast("ØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÛŒ Ø®Ø§Ù†Ø§Ù† Ù¾Ú• Ø¨Ú©Û• âš ï¸");
                try {
                    const doc = await firestore.collection('users').doc(phone).get();
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.password === pass) {
                            this.state.user = userData;
                            if(!this.state.user.points) this.state.user.points = 0;
                            this.saveUserLocally(); this.toggleAuthOverlay(); this.showToast("Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ± Ø³Û•Ø±Ú©Û•ÙØªÛŒ Ø¨ÙˆÙˆ âœ…");
                            this.checkHeaderStatus(); this.fetchLiveOrders();
                        } else { this.showToast("ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ù‡Û•ÚµÛ•ÛŒÛ•! âŒ"); }
                    } else {
                        if(confirm("Ø¦Û•Ú¤ Ú˜Ù…Ø§Ø±Û• Ù†ÛŒÙ†Û•. ØªÛ• Ø¯Ú¤ÛØª Ù‡Û•Ú˜Ù…Ø§Ø±Û•Ú©Ø§ Ù†ÙˆÛ Ø¯Ø±ÙˆØ³Øª Ø¨Ú©Û•ÛŒØŸ")) { this.switchAuth('register'); document.getElementById('reg-phone').value = phone; }
                    }
                } catch (error) { this.showToast("Ù‡Û•ÚµÛ• Ù‡Û•ÛŒÛ•! Ø¦ÛŒÙ†ØªÛ•Ø±Ù†ÛØª Ù¾Ø´Ú©Ù†Û• âŒ"); }
            },

            logout() {
                if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„ Ø¯Û•Ø±Ú©Û•Ú¤ØªÙ†ÛØŸ")) {
                    localStorage.removeItem('user_pro_max');
                    this.state.user = null; this.state.orders = [];
                    if(this.state.ordersListener) this.state.ordersListener(); 
                    if(this.state.pointsListener) { this.state.pointsListener(); this.state.pointsListener = null; }
                    location.reload();
                }
            },
            saveUserLocally() { localStorage.setItem('user_pro_max', JSON.stringify(this.state.user)); },

            applyPointsDiscount() {
                const select = document.getElementById('points-select');
                const pointsNeeded = parseInt(select.value);
                const currentPoints = this.state.user ? this.state.user.points : 0;
                const msg = document.getElementById('points-msg');

                if(pointsNeeded === 0) {
                    this.state.pointsDiscount = 0;
                    msg.innerText = "";
                    this.updateCartUI();
                    return;
                }
                const rule = this.state.pointRules.find(r => r.points === pointsNeeded);
                if(currentPoints >= pointsNeeded && rule) {
                    this.state.pointsDiscount = rule.discount;
                    msg.innerText = "Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† Ú†Ø§Ù„Ø§Ú© Ø¨ÙˆÙˆ âœ…";
                    msg.style.color = "var(--success)";
                    this.updateCartUI();
                } else {
                    this.state.pointsDiscount = 0;
                    msg.innerText = "Ø®Ø§ÚµÛÙ† ØªÛ• ØªÛØ± Ù†Ø§Ú©Û•Ù† âŒ";
                    msg.style.color = "var(--danger)";
                    select.value = "0";
                    this.updateCartUI();
                }
            },
            
            updateDeliveryFee() {
                this.updateCartUI();
            },

            async smartCheckout() {
                const t = translations[this.state.lang];
                if(this.state.cart.length === 0) return this.showToast(t['empty_cart'] + " ğŸ›’");
                
                if(!this.state.user) {
                    this.showToast("ØªÚ©Ø§ÛŒÛ• Ø³Û•Ø±Û•ØªØ§ Ú†ÙˆÙˆÙ†Û• Ú˜ÙˆÙˆØ±Û Ø¨Ú©Û• ğŸ”’");
                    this.toggleAuthOverlay();
                    return;
                }
                
                const selectedCity = document.getElementById('delivery-city-select').value;
                const details = document.getElementById('delivery-details').value.trim();

                if(!selectedCity || selectedCity === "") {
                    const sel = document.getElementById('delivery-city-select');
                    sel.style.borderColor = 'red';
                    sel.focus();
                    setTimeout(() => sel.style.borderColor = '#e67e22', 1000);
                    return this.showToast("ØªÚ©Ø§ÛŒÛ• Ø¨Ø§Ú˜ÛÚ• / Ø¯Û•Ú¤Û•Ø±Û Ù‡Û•ÚµØ¨Ú˜ÛØ±Û• âš ï¸");
                }

                const verificationCode = Math.floor(1000 + Math.random() * 9000).toString();
                
                let totalBooks = 0;
                let verifiedItems = [];

                for (let item of this.state.cart) {
                    const originalBook = this.state.books.find(b => b.id === item.id);
                    if(originalBook) {
                        const lib = this.state.libraries.find(l => l.id === originalBook.libId);
                        let realPrice = originalBook.price;
                        let libDiscount = (lib && lib.discountPercent) ? lib.discountPercent : 0;
                        
                        if(libDiscount > 0) {
                            realPrice = realPrice - (realPrice * libDiscount);
                        }
                        if(item.bulkQty && item.qty >= item.bulkQty) {
                             realPrice = item.bulkPrice || realPrice;
                        }

                        totalBooks += (realPrice * item.qty);
                        verifiedItems.push({
                            ...item,
                            price: realPrice 
                        });
                    }
                }
                
                let delivery = this.state.deliveryFee; 
                
                const totalDiscountPercent = this.state.discount + this.state.pointsDiscount;
                const discountAmount = totalBooks * totalDiscountPercent;
                const finalTotal = (totalBooks + delivery) - discountAmount;
                
                const pointsUsed = parseInt(document.getElementById('points-select').value) || 0;
                const earnedPoints = Math.floor(finalTotal / 2000);

                const orderId = Date.now();
                const userPhone = String(this.state.user.phone).trim();

                const newOrder = {
                    id: orderId,
                    userId: userPhone,
                    userName: this.state.user.name,
                    userAddress: this.state.user.address,
                    userCity: selectedCity, 
                    userDetails: details, 
                    date: new Date().toLocaleDateString('ku-IQ'),
                    time: new Date().toLocaleTimeString(),
                    items: verifiedItems, 
                    total: finalTotal,
                    deliveryFee: delivery,
                    earnedPoints: earnedPoints, 
                    pointsUsed: pointsUsed,
                    status: 'waiting', 
                    code: verificationCode
                };

                try {
                    await firestore.collection('orders').doc(orderId.toString()).set(newOrder);
                    
                    if(pointsUsed > 0) {
                        const currentP = parseInt(this.state.user.points) || 0;
                        let newPoints = currentP - pointsUsed;
                        if(newPoints < 0) newPoints = 0;
                        await firestore.collection('users').doc(userPhone).update({
                            points: newPoints
                        });
                        this.state.user.points = newPoints;
                        this.saveUserLocally();
                    }
                    
                    this.state.cart = [];
                    this.saveCart();
                    
                    this.showToast(t['sent_msg']);
                    
                    document.getElementById('points-select').value = "0";
                    document.getElementById('delivery-details').value = ""; 
                    this.state.pointsDiscount = 0;

                    setTimeout(() => {
                        const profileBtn = document.querySelectorAll('.nav-item')[2];
                        this.nav('profile', profileBtn);
                    }, 800);
                    
                } catch (error) {
                    console.error("Order failed:", error);
                    this.showToast("Ù‡Û•ÚµÛ•! Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ù†Û•Ú†ÙˆÙˆ âŒ");
                }
            },

            openVerifyModal(orderId) {
                this.state.verifyOrderId = orderId;
                document.getElementById('verify-input').value = '';
                document.getElementById('verify-modal').style.display = 'flex';
                this.state.isSubmitting = false;
                document.getElementById('btn-submit-verify').disabled = false;
            },
            closeVerifyModal() { document.getElementById('verify-modal').style.display = 'none'; this.state.verifyOrderId = null; },
            
            async submitVerify() {
                if(this.state.isSubmitting) return;
                this.state.isSubmitting = true;
                document.getElementById('btn-submit-verify').disabled = true;

                const inputCode = document.getElementById('verify-input').value.trim();
                const orderId = this.state.verifyOrderId;
                const order = this.state.orders.find(o => o.id === orderId);
                
                if (order && inputCode === order.code) {
                    try {
                        const orderRef = firestore.collection('orders').doc(orderId.toString());
                        const freshDoc = await orderRef.get();
                        
                        if(freshDoc.exists && freshDoc.data().status === 'delivered') {
                            this.showToast("Ø¦Û•Ú¤ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛ• Ù¾ÛØ´ØªØ± Ù‡Ø§ØªØ¨Ùˆ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†! âŒ");
                            this.closeVerifyModal();
                            return;
                        }

                        await orderRef.update({ status: 'delivered' });
                        
                        if(order.earnedPoints && order.earnedPoints > 0) {
                             const userPhone = this.state.user.phone;
                             await firestore.collection('users').doc(userPhone).update({
                                 points: firebase.firestore.FieldValue.increment(order.earnedPoints)
                             });
                             this.state.user.points += order.earnedPoints;
                             this.saveUserLocally();
                             this.updateProfileUI();

                             this.showToast(`Ù¾ÛŒØ±Û†Ø²Û•! ${order.earnedPoints} Ø®Ø§Úµ Ø¨Û† ØªÛ• Ù‡Ø§ØªÙ†Û• Ø²ÛŒØ§Ø¯Ú©Ø±Ù† ğŸŒŸ`);
                        } else {
                             this.showToast(translations[this.state.lang]['code_success']);
                        }
                        this.closeVerifyModal();
                    } catch (err) { 
                        this.showToast("Ù‡Û•ÚµÛ• Ù„ Ù†ÙˆÛÚ©Ø±Ù†Û! âŒ");
                        this.state.isSubmitting = false;
                        document.getElementById('btn-submit-verify').disabled = false;
                    }
                } else {
                    this.showToast(translations[this.state.lang]['wrong_code']);
                    this.state.isSubmitting = false;
                    document.getElementById('btn-submit-verify').disabled = false;
                }
            },

            renderLibraries() {
                const libsWithDiscount = this.state.libraries.map(lib => {
                    const hasDiscount = lib.discountPercent && lib.discountPercent > 0;
                    return { ...lib, hasDiscount };
                });
                
                libsWithDiscount.sort((a, b) => (b.hasDiscount ? 1 : 0) - (a.hasDiscount ? 1 : 0));
                
                const con = document.getElementById('stories-list');
                con.innerHTML = libsWithDiscount.map(lib => `
                    <div class="story-item ${lib.hasDiscount ? 'has-discount' : ''}" onclick="app.filterByLibrary(${lib.id}, this)">
                        <div class="story-ring">
                            <img src="${lib.img}" class="story-img" onerror="this.src='${DEFAULT_IMG}'">
                            ${lib.hasDiscount ? '<div class="discount-badge-story">%</div>' : ''}
                        </div>
                        <div class="story-name">${lib.name}</div>
                    </div>
                `).join('');
            },

            filterByLibrary(libId, el) {
                document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
                if (this.state.activeLibFilter === libId) {
                    this.state.activeLibFilter = null;
                    el.classList.remove('active-lib');
                    document.querySelector('.cat-chip[onclick*="all"]').classList.add('active');
                    this.renderBooks(this.state.books);
                } else {
                    this.state.activeLibFilter = libId;
                    document.querySelectorAll('.story-item').forEach(s => s.classList.remove('active-lib'));
                    el.classList.add('active-lib');
                    const filtered = this.state.books.filter(b => b.libId === libId);
                    this.renderBooks(filtered);
                    const libName = this.state.libraries.find(l => l.id === libId).name;
                    this.showToast(`Ù¾Û•Ø±ØªÙˆÙˆÚ©ÛÙ†: ${libName}`);
                }
            },

            openPreview() {
                const b = this.state.currentBook;
                if(b && b.previewImages && b.previewImages.length > 0) {
                     const container = document.getElementById('preview-container');
                     container.innerHTML = b.previewImages.map(src => `<img src="${src}" class="preview-page" onerror="this.style.display='none'">`).join('');
                     document.getElementById('preview-modal').style.display = 'block';
                } else {
                    this.showToast("Ù¾ÛØ´Ø§Ù†Ø¯Ø§Ù†ÛŒ Ù†ÛŒÛŒÛ•");
                }
            },
            closePreview() { document.getElementById('preview-modal').style.display = 'none'; },
            
            showToast(msg) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<div class="toast-icon"><i class="fas fa-check"></i></div> <div>${msg}</div>`;
                if(msg.includes('âš ï¸') || msg.includes('âŒ')) { toast.querySelector('.toast-icon').classList.add('error'); toast.querySelector('.toast-icon').innerHTML = '<i class="fas fa-exclamation"></i>'; }
                container.appendChild(toast);
                requestAnimationFrame(() => toast.classList.add('show'));
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
            },

            async applyCoupon() {
                const code = document.getElementById('coupon-input').value.trim().toUpperCase();
                const msg = document.getElementById('coupon-msg');
                if(!code) return;
                try {
                    const doc = await firestore.collection('coupons').doc(code).get();
                    if (doc.exists) {
                        const data = doc.data();
                        this.state.discount = data.discount; 
                        msg.innerText = `Ù¾ÛŒØ±Û†Ø²Û•! Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù† (%${data.discount * 100}) Ú†Ø§Ù„Ø§Ú© Ø¨ÙˆÙˆ âœ…`;
                        msg.style.color = "var(--success)";
                    } else {
                         this.state.discount = 0;
                         msg.innerText = "Ú©Û†Ø¯ Ø´Ø§Ø´Û• âŒ";
                         msg.style.color = "var(--danger)";
                    }
                } catch (err) { this.state.discount = 0; msg.innerText = "Ú©ÛØ´Û• Ù‡Û•ÛŒÛ• âŒ"; }
                this.updateCartUI();
            },

            toggleTheme() {
                this.state.darkMode = !this.state.darkMode;
                if (this.state.darkMode) { document.body.setAttribute('data-theme', 'dark'); localStorage.setItem('theme_pro_max', 'dark'); } 
                else { document.body.removeAttribute('data-theme'); localStorage.setItem('theme_pro_max', 'light'); }
            },

            nav(screenId, el) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if(el) el.classList.add('active');
                window.scrollTo(0, 0);
                if(screenId === 'profile') { this.renderOrderHistory(); this.updateProfileUI(); }
            },

            renderBooks(list) {
                const grid = document.getElementById('book-grid');
                if(list.length === 0) {
                     grid.innerHTML = `<p style="text-align:center; width:200%; padding:20px;">Ù‡ÛŒÚ† Ù¾Û•Ø±ØªÙˆÙˆÚ©ÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ•.</p>`;
                     return;
                }
                grid.innerHTML = list.map(b => {
                    const isFav = this.state.favs.includes(b.id);
                    const lib = this.state.libraries.find(l => l.id === b.libId);
                    const libName = lib ? lib.name : "Library";
                    
                    let priceDisplay = b.price.toLocaleString();
                    let finalPrice = b.price;
                    let hasDiscount = false;
                    let originalPriceDisplay = "";

                    if(lib && lib.discountPercent && lib.discountPercent > 0) {
                        finalPrice = b.price - (b.price * lib.discountPercent);
                        priceDisplay = finalPrice.toLocaleString();
                        originalPriceDisplay = b.price.toLocaleString();
                        hasDiscount = true;
                    }
                    
                    let priceHtml = `<span class="price">${priceDisplay}</span>`;
                    if(hasDiscount) {
                        priceHtml = `<span class="price discount-price">${priceDisplay}</span>
                                     <span class="old-price">${originalPriceDisplay}</span>`;
                    } else if(b.originalPrice && b.originalPrice > b.price) {
                         priceHtml = `<span class="price discount-price">${b.price.toLocaleString()}</span>
                                     <span class="old-price">${b.originalPrice.toLocaleString()}</span>`;
                    }
                    
                    let wholesaleBadge = '';
                    if(b.bulkQty) {
                        wholesaleBadge = `<div class="wholesale-badge">Ø¯Ø§Ø´Ú©Ø§Ù†Ø¯Ù†Ø§ Ø¬ÙˆÙ…Ù„Û• Ù‡Û•ÛŒÛ•</div>`;
                    }

                    return `
                    <div class="card">
                        <div class="card-img-c" onclick="app.openModal(${b.id})">
                            <span class="card-badge">${b.cat || 'General'}</span>
                            <img src="${b.img}" class="card-img" onerror="this.onerror=null;this.src='${DEFAULT_IMG}';">
                            <div class="lib-tag"><i class="fas fa-building"></i> ${libName}</div>
                        </div>
                        <div class="card-fav ${isFav ? 'active' : ''}" onclick="app.toggleFav(${b.id}, this)">
                            <i class="${isFav ? 'fas' : 'far'} fa-heart"></i>
                        </div>
                        <div class="card-body" onclick="app.openModal(${b.id})">
                            <div class="card-title">${b.title}</div>
                            <div class="card-author">${b.author}</div>
                            <div class="card-footer">
                                <div>${priceHtml}</div>
                                <div class="btn-add"><i class="fas fa-plus"></i></div>
                            </div>
                            ${wholesaleBadge}
                        </div>
                    </div>
                `}).join('');
            },

            toggleFav(id, btn) {
                const idx = this.state.favs.indexOf(id);
                if (idx > -1) {
                    this.state.favs.splice(idx, 1);
                    btn.classList.remove('active');
                    btn.querySelector('i').classList.replace('fas', 'far');
                } else {
                    this.state.favs.push(id);
                    btn.classList.add('active');
                    btn.querySelector('i').classList.replace('far', 'fas');
                    this.showToast("Ù‡Ø§ØªÛ• Ø²ÛØ¯Û•Ú©Ø±Ù† Ø¨Û† Ø¯ÚµØ®ÙˆØ§Ø²Ø§Ù† â¤ï¸");
                }
                localStorage.setItem('favs_pro_max', JSON.stringify(this.state.favs));
            },

            filter(cat, el) {
                this.state.activeLibFilter = null;
                document.querySelectorAll('.story-item').forEach(s => s.classList.remove('active-lib'));
                document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                
                if(cat === 'city') {
                    const cityDiv = document.getElementById('city-filters');
                    cityDiv.style.display = cityDiv.style.display === 'none' ? 'flex' : 'none';
                    return; 
                } else {
                    document.getElementById('city-filters').style.display = 'none';
                }

                if (cat === 'all') this.renderBooks(this.state.books);
                else if (cat === 'favorites') this.renderBooks(this.state.books.filter(b => this.state.favs.includes(b.id)));
                else if (cat === 'discounted') {
                    const discountedBooks = this.state.books.filter(b => {
                        const lib = this.state.libraries.find(l => l.id === b.libId);
                        return (lib && lib.discountPercent > 0) || (b.originalPrice && b.originalPrice > b.price);
                    });
                    this.renderBooks(discountedBooks);
                }
                else this.renderBooks(this.state.books.filter(b => b.cat === cat));
            },

            filterCity(cityName) {
                const libIds = this.state.libraries.filter(l => l.city === cityName).map(l => l.id);
                const filtered = this.state.books.filter(b => libIds.includes(b.libId));
                this.renderBooks(filtered);
                this.showToast(`Ù¾Û•Ø±ØªÙˆÙˆÚ©Ø®Ø§Ù†ÛÙ†: ${cityName}`);
            },

            openModal(id) {
                const b = this.state.books.find(x => x.id === id);
                const lib = this.state.libraries.find(l => l.id === b.libId);
                this.state.currentBook = b;
                
                document.getElementById('m-img').src = b.img;
                document.getElementById('m-img').onerror = function() { this.src = DEFAULT_IMG; };
                document.getElementById('m-title').innerText = b.title;
                document.getElementById('m-cat').innerText = b.cat || 'General';
                document.getElementById('m-lib').innerText = lib ? lib.name : 'Library';
                document.getElementById('m-author').innerText = b.author;
                document.getElementById('m-desc').innerText = b.desc || 'Ù‡ÛŒÚ† Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú© Ù†ÛŒÛŒÛ•.';
                
                let finalPrice = b.price;
                if(lib && lib.discountPercent && lib.discountPercent > 0) {
                     finalPrice = b.price - (b.price * lib.discountPercent);
                }
                document.getElementById('m-price').innerText = finalPrice.toLocaleString() + ' IQD';

                const pagesEl = document.getElementById('row-pages');
                if(b.pages) {
                    pagesEl.style.display = 'flex';
                    document.getElementById('m-pages').innerText = b.pages;
                } else {
                    pagesEl.style.display = 'none';
                }

                const tahqiqEl = document.getElementById('row-tahqiq');
                if(b.tahqiq) {
                    tahqiqEl.style.display = 'flex';
                    document.getElementById('m-tahqiq').innerText = b.tahqiq;
                } else {
                    tahqiqEl.style.display = 'none';
                }

                const paperEl = document.getElementById('row-paper');
                if(b.paper) {
                    paperEl.style.display = 'flex';
                    document.getElementById('m-paper').innerText = b.paper;
                } else {
                    paperEl.style.display = 'none';
                }

                const volumesEl = document.getElementById('row-volumes');
                if(b.volumes) {
                    volumesEl.style.display = 'flex';
                    document.getElementById('m-volumes').innerText = b.volumes;
                } else {
                    volumesEl.style.display = 'none';
                }
                
                const wsRow = document.getElementById('m-wholesale-row');
                if(b.bulkQty && b.bulkQty > 0) {
                    wsRow.style.display = 'flex';
                    document.getElementById('m-bulk-qty').innerText = b.bulkQty;
                } else {
                    wsRow.style.display = 'none';
                }

                const deliveryRow = document.getElementById('m-delivery-row');
                if (lib && lib.freeDeliveryLimit && lib.freeDeliveryLimit > 0) {
                    deliveryRow.style.display = 'flex';
                    document.getElementById('m-free-limit').innerText = lib.freeDeliveryLimit.toLocaleString();
                } else {
                    deliveryRow.style.display = 'none'; 
                }

                const relatedContainer = document.getElementById('related-books-container');
                const relatedBooks = this.state.books.filter(book => book.id !== b.id && book.libId === b.libId && (book.author === b.author || book.cat === b.cat));

                if(relatedBooks.length > 0) {
                    document.querySelector('.related-books-section').style.display = 'block';
                    relatedContainer.innerHTML = relatedBooks.map(rb => `<div class="related-card" onclick="app.openModal(${rb.id})"><img src="${rb.img}" class="related-img" onerror="this.src='${DEFAULT_IMG}'"><div class="related-name">${rb.title}</div></div>`).join('');
                } else {
                    document.querySelector('.related-books-section').style.display = 'none';
                }
                document.getElementById('product-modal').classList.add('open');
            },

            closeModal() { document.getElementById('product-modal').classList.remove('open'); },
            shareBook() {
                const b = this.state.currentBook;
                if(navigator.share) {
                    navigator.share({ title: b.title, text: `Ø¨Û•Ø±ÛØ®ÙˆÛ• Ø¨Ø¯Û• Ú¤Û Ù¾Û•Ø±ØªÙˆÙˆÚ©Û: ${b.title}`, url: window.location.href });
                } else { this.showToast("Ù¾Ø§Ø±Ú¤Û•Ú©Ø±Ù† Ù„ Ø³Û•Ø± Ú¤ÛŒ Ø¦Ø§Ù…ÛØ±ÛŒ Ù†ÛŒÙ†Û•"); }
            },

            addToCartFromModal() {
                const b = this.state.currentBook;
                const exist = this.state.cart.find(x => x.id === b.id);
                if (exist) exist.qty++; else this.state.cart.push({ ...b, qty: 1 });
                this.saveCart(); this.closeModal(); this.showToast("Ù‡Ø§ØªÛ• Ø²ÛØ¯Û•Ú©Ø±Ù† Ø¨Û† Ø³Û•Ø¨Û•ØªÛ•ÛŒÛ âœ…");
            },

            saveCart() { localStorage.setItem('cart_pro_max', JSON.stringify(this.state.cart)); this.updateCartUI(); },

            updateCartUI() {
                const count = this.state.cart.reduce((a, b) => a + b.qty, 0);
                document.getElementById('cart-count').innerText = count;
                document.getElementById('my-current-points').innerText = this.state.user ? (this.state.user.points || 0) : 0;

                const list = document.getElementById('cart-list');
                const t = translations[this.state.lang];
                let totalBooks = 0;
                
                let deliveryFee = 0;
                let freeLimit = 0; 
                const selectedCity = document.getElementById('delivery-city-select') ? document.getElementById('delivery-city-select').value : "";
                
                let libDiscount = 0;
                
                if (this.state.cart.length > 0) {
                    const libId = this.state.cart[0].libId;
                    const lib = this.state.libraries.find(l => l.id === libId);
                    
                    if (lib) {
                        freeLimit = lib.freeDeliveryLimit || 0; 
                        if(lib.discountPercent) libDiscount = lib.discountPercent;

                        if (selectedCity && lib.city === selectedCity) {
                            deliveryFee = lib.localPrice || 2000; 
                        } else if(selectedCity) {
                            deliveryFee = lib.foreignPrice || 5000; 
                        } else {
                            deliveryFee = 0;
                        }
                    } else {
                        deliveryFee = 5000; 
                    }
                }

                if (this.state.cart.length === 0) {
                    list.innerHTML = `<p style="text-align:center; color:var(--text-light); margin-top:20px;">${t['empty_cart']}</p>`;
                    this.state.discount = 0;
                    this.state.deliveryFee = 0;
                    document.getElementById('coupon-msg').innerText = '';
                    document.getElementById('coupon-input').value = '';
                } else {
                    list.innerHTML = this.state.cart.map(item => {
                        let finalPrice = item.price;
                        if(libDiscount > 0) {
                             finalPrice = finalPrice - (finalPrice * libDiscount);
                        }

                        let isWholesale = false;
                        if(item.bulkQty && item.qty >= item.bulkQty) {
                            finalPrice = item.bulkPrice || finalPrice; 
                            isWholesale = true;
                        }
                        const rowTotal = finalPrice * item.qty;
                        totalBooks += rowTotal;
                        return `
                            <div class="cart-item">
                                <img src="${item.img}" class="cart-img" onerror="this.onerror=null;this.src='${DEFAULT_IMG}';">
                                <div style="flex:1;">
                                    <div style="font-weight:bold; color:var(--text-main);">${item.title}</div>
                                    <div style="color:var(--primary);">
                                        ${finalPrice.toLocaleString()} IQD
                                        ${isWholesale ? '<span style="color:red; font-size:0.7rem;">(Ø¬ÙˆÙ…Ù„Û•)</span>' : ''}
                                    </div>
                                </div>
                                <div class="qty-control">
                                    <div class="qty-btn" onclick="app.changeQty(${item.id}, -1)">-</div>
                                    <span style="padding:0 5px; color:var(--text-main);">${item.qty}</span>
                                    <div class="qty-btn" onclick="app.changeQty(${item.id}, 1)">+</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                if (this.state.cart.length > 0 && selectedCity) {
                    if(freeLimit > 0 && totalBooks >= freeLimit) {
                        deliveryFee = 0;
                    }
                }
                this.state.deliveryFee = deliveryFee;

                const totalDiscountPercent = this.state.discount + this.state.pointsDiscount;
                const discountAmount = totalBooks * totalDiscountPercent;
                const finalAmount = (totalBooks + this.state.deliveryFee) - discountAmount;

                document.getElementById('sub-total').innerText = totalBooks.toLocaleString() + ' IQD';
                document.getElementById('delivery-fee').innerText = this.state.deliveryFee.toLocaleString() + ' IQD';
                document.getElementById('discount-val').innerText = '-' + discountAmount.toLocaleString() + ' IQD';
                document.getElementById('final-total').innerText = finalAmount.toLocaleString() + ' IQD';
            },

            changeQty(id, delta) {
                const item = this.state.cart.find(x => x.id === id);
                if (item) {
                    item.qty += delta;
                    if (item.qty <= 0) this.state.cart = this.state.cart.filter(x => x.id !== id);
                    this.saveCart();
                }
            },

            updateProfileUI() {
                const u = this.state.user;
                if(!u) return;
                document.getElementById('p-name-display').innerText = u.name;
                document.getElementById('p-phone-display').innerText = u.phone;
                document.getElementById('p-points-display').innerText = u.points || 0;
                
                document.getElementById('val-name').innerText = u.name;
                document.getElementById('val-phone').innerText = u.phone;
                document.getElementById('val-city').innerText = u.city || "--";
                document.getElementById('val-address').innerText = u.address;
                
                document.getElementById('inp-name').value = u.name;
                document.getElementById('inp-phone').value = u.phone;
                
                if(document.getElementById('inp-city').options.length > 0) {
                    document.getElementById('inp-city').value = u.city || "Duhok";
                }
                document.getElementById('inp-address').value = u.address;
            },

            toggleEditMode() {
                this.state.isEditMode = !this.state.isEditMode;
                const icon = document.getElementById('edit-icon');
                const logoutBtn = document.getElementById('btn-logout-edit');
                if (this.state.isEditMode) { icon.className = 'fas fa-check'; logoutBtn.classList.remove('hidden'); } 
                else { icon.className = 'fas fa-edit'; logoutBtn.classList.add('hidden'); }
                document.querySelectorAll('.info-val').forEach(el => el.classList.toggle('hidden'));
                document.querySelectorAll('.edit-input').forEach(el => el.classList.toggle('hidden'));
                document.getElementById('save-btn-container').classList.toggle('hidden');
            },

            async saveProfileChanges() {
                const newName = document.getElementById('inp-name').value;
                const newAddress = document.getElementById('inp-address').value;
                const newCity = document.getElementById('inp-city').value;
                const currentPhone = this.state.user.phone; 
                if(newName && newAddress && newCity) {
                    try {
                        await firestore.collection('users').doc(currentPhone).update({ name: newName, address: newAddress, city: newCity });
                        this.state.user.name = newName; this.state.user.address = newAddress; this.state.user.city = newCity;
                        this.saveUserLocally(); this.toggleEditMode(); this.updateProfileUI(); this.showToast("Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‡Ø§ØªÙ†Û• Ù†ÙˆÛÚ©Ø±Ù† âœ…");
                    } catch(err) { this.showToast("Ù‡Û•ÚµÛ• Ù‡Û•ÛŒÛ• Ù„ Ù†ÙˆÛÚ©Ø±Ù†Û! âŒ"); }
                } else { this.showToast("Ù†Ø§Ø¨ÛØª Ø®Ø§Ù†Û• Ø¨Û•ØªØ§Úµ Ø¨Ù† âš ï¸"); }
            }
        };

        app.init();
    </script>
</body>
</html>

